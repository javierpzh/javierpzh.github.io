<!DOCTYPE html>
<html lang="es">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Certificados digitales. HTTPS | Javier Pérez Hidalgo</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Certificado digital de persona física Tarea 1: Instalación del certificado 1. Una vez que hayas obtenido tu certificado, explica...">

        <meta name="author" content="Javier Pérez Hidalgo">

        <meta name="tags" content="Criptografía">
        <meta name="tags" content="Certificado digital">
        <meta name="tags" content="HTTPS">
        <meta name="tags" content="SSL">
        <meta name="tags" content="Apache">
        <meta name="tags" content="Nginx">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Javier Pérez Hidalgo">

	<meta property="og:type" content="article">
            <meta property="article:author" content="/author/javier-perez-hidalgo.html">
	<meta property="og:url" content="/certificados-digitales-https.html">
	<meta property="og:title" content="Certificados digitales. HTTPS">
	<meta property="article:published_time" content="2020-11-17 00:00:00+01:00">
            <meta property="og:description" content="Certificado digital de persona física Tarea 1: Instalación del certificado 1. Una vez que hayas obtenido tu certificado, explica...">

            <meta property="og:image" content="theme/images/banner-seguridad.jpg">
</head>

<body class="article-certificados-digitales-https">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
        <!--    <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>-->
                <a class="navbar-brand" href="/">Inicio</a>
                <a class="navbar-brand" href="/categories">Categorías</a>
                <a class="navbar-brand" href="/authors">Sobre mí</a>

            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/banner-seguridad.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Certificados digitales. HTTPS</h1>
                        <span class="meta">Publicado por
                                <a href="/author/javier-perez-hidalgo.html">Javier Pérez Hidalgo</a>
                             el mar 17 noviembre 2020
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <h2>Certificado digital de persona física</h2>
<h4>Tarea 1: Instalación del certificado</h4>
<p><strong>1. Una vez que hayas obtenido tu certificado, explica brevemente como se instala en tu navegador favorito.</strong></p>
<p>Una vez hemos solicitado y descargado nuestro certificado digital, se nos guardará en forma de una especie de carpeta/fichero que son los que tendremos que utilizar.</p>
<p>En mi caso utilizo <strong>Mozilla Firefox</strong>, por tanto lo voy a instalar en este navegador.</p>
<p>Nos dirigimos al menú de <strong>Preferencias</strong> del navegador, y en el apartado de <strong>Privacidad &amp; Seguridad</strong>, nos desplazamos hasta la último opción, llamada <strong>Certificados</strong>. Aquí haremos <em>click</em> en <strong>Ver certificados</strong> y se nos abrirá una pequeña ventana en la que tendremos distintas secciones. Nos interesa la sección <strong>Sus certificados</strong>, y aquí haremos <em>click</em> en <strong>Importar</strong> y se nos abrirá una ventana donde tendremos que seleccionar el certificado que hemos descargado antes, y con esto, ya tendremos instalado nuestro certificado en nuestro navegador.</p>
<p><strong>2. Muestra una captura de pantalla donde se vea las preferencias del navegador donde se ve instalado tu certificado.</strong></p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/certinstalado.png"></p>
<p><strong>3. ¿Cómo puedes hacer una copia de tu certificado? ¿Como vas a realizar la copia de seguridad de tu certificado? Razona la respuesta.</strong></p>
<p>En la ventana de la imagen anterior, si seleccionamos nuestro certificado, y seleccionamos la opción <strong>Hacer copia...</strong> y elegimos una ruta en nuestro PC, habremos hecho una copia del certificado instalado.</p>
<p>...</p>
<p>...</p>
<p>...</p>
<p>...</p>
<p><strong>4. Investiga como exportar la clave pública de tu certificado.</strong></p>
<p>Para exportar nuestra clave pública, debemos hacer doble <em>click</em> en nuestro certificado, y se nos abrirá una nueva pestaña con la información del certificado. Nos dirigimos hasta el apartado <strong>Información de clave pública</strong> y aquí encontraremos nuestra clave pública y ya podremos exportarla y compartirla:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/infoclavepublica.png"></p>
<h4>Tarea 2: Validación del certificado</h4>
<p><strong>1. Instala en tu ordenador el software <a href="https://firmaelectronica.gob.es/Home/Descargas.html">autofirma</a> y desde la página de <em>VALIDe</em>, valida tu certificado. Muestra capturas de pantalla donde se comprueba la validación.</strong></p>
<p>Para instalar <strong>Autofirma</strong> sobre <em>Debian</em>, tenemos que tener en cuenta que necesitamos tener instalado <strong>Java</strong>. Para instalar <em>Java</em> ejecutamos:</p>
<pre>
sudo apt install default-jdk openjdk-11-jdk libnss3-tools -y
</pre>

<p>Verificamos la versión instalada:</p>
<pre>
javier@debian:~/Descargas/AutoFirma_Linux$ java -version
openjdk version "11.0.9" 2020-10-20
OpenJDK Runtime Environment (build 11.0.9+11-post-Debian-1deb10u1)
OpenJDK 64-Bit Server VM (build 11.0.9+11-post-Debian-1deb10u1, mixed mode, sharing)
</pre>

<p>Ahora nos descargamos el programa de instalación de <em>Autofirma</em> desde este <a href="https://firmaelectronica.gob.es/Home/Descargas.html">enlace</a>.</p>
<p>Una vez descargado y descomprimido, instalamos el paquete <code>.deb</code>:</p>
<pre>
sudo dpkg -i AutoFirma_1_6_5.deb
</pre>

<p>Y ya tendríamos instalado <strong>Autofirma</strong>. Comprobamos que lo podemos abrir:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirma.png"></p>
<p>Para validar nuestro certificado, nos dirigimos a la página de <strong>VALIDe</strong> y al apartado <strong><a href="https://valide.redsara.es/valide/validarCertificado/ejecutar.html">Validar Certificado</a></strong>. Seleccionamos el certificado mediante el software de <em>Autofirma</em>:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/certautofirma.png"></p>
<p>Seleccionamos nuestro certificado y hacemos <em>click</em> en <strong>Validar</strong>, y obtendremos una respuesta sobre sí el certificado es válido o no. En mi caso:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/certvalido.png"></p>
<h4>Tarea 3: Firma electrónica</h4>
<p><strong>1. Utilizando la página <em>VALIDe</em> y el programa <em>Autofirma</em>, firma un documento con tu certificado y envíalo por correo a un compañero.</strong></p>
<p>Con <strong>Autofirma</strong>:</p>
<p>Para firmar un documento con nuestro certificado y el programa <em>Autofirma</em>, seleccionamos <strong>Seleccionar ficheros a firmar</strong>:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirma.png"></p>
<p>Seleccionamos el documento que deseamos firmar:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmaseleccfichero.png"></p>
<p>Seleccionamos con que certificado queremos firmar el documento:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmaselecccert.png"></p>
<p>Guardamos el fichero ya firmado con nuestro certificado:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmaguardarficherofirm.png"></p>
<p>Vemos que ya hemos firmado y guardado el documento firmado:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmaficherofirm.png"></p>
<p>Con <strong>Valide</strong>:</p>
<p>Para firmar un documento con mi certificado y el programa <em>Valide</em>, nos dirigimos a la página de <em>VALIDe</em> y al apartado <strong><a href="https://valide.redsara.es/valide/firmar/ejecutar.html">Realizar Firma</a></strong>.</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/validepagfirmar.png"></p>
<p>Seleccionamos el documento que deseamos firmar:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/valideseleccfichero.png"></p>
<p>Seleccionamos con que certificado queremos firmar el documento:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/valideselecccert.png"></p>
<p>Vemos que ya hemos firmado el documento pero aún no lo hemos guardado en nuestro equipo:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/valideficherofirm.png"></p>
<p>Guardamos el fichero ya firmado con nuestro certificado:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/valideguardarficherofirm.png"></p>
<p>Vemos que ya hemos firmado y guardado el documento firmado:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/valideficherofirmyguardado.png"></p>
<p>Ya dispongo de los documentos firmados, llamados <code>documentofirmadoautofirma.txt_signed.csig</code> y <code>documentofirmadovalide.txt.csig</code>, y se lo envío a mi compañero <a href="https://www.instagram.com/whosalvr/">Álvaro</a>.</p>
<p><strong>2. Tu debes recibir otro documento firmado por un compañero y utilizando las herramientas anteriores debes visualizar la firma (Visualizar Firma) y (Verificar Firma). ¿Puedes verificar la firma aunque no tengas la clave pública de tu compañero? ¿Es necesario estar conectado a internet para hacer la validación de la firma? Razona tus respuestas.</strong></p>
<p>He recibido de Álvaro los documentos <code>ficheroautofirma.txt_signed.csig</code> y <code>ficherovalide.txt_signed.csig</code>.</p>
<p>Con <strong>Autofirma</strong>:</p>
<p>En el programa <em>Autofirma</em> seleccionamos la opción <strong>Ver firma</strong>:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmaverificarfirma.png"></p>
<p>Seleccionamos el fichero del cuál queremos ver la firma:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmaverificarfirmaseleccfichero.png"></p>
<p>Nos sale que está firmado por Álvaro:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmafirmaverificada.png"></p>
<p>Con <strong>Valide</strong>:</p>
<p>Para verificar la firma de un documento y el programa <em>Valide</em>, nos dirigimos a la página de <em>VALIDe</em> y al apartado <strong><a href="https://valide.redsara.es/valide/validarFirma/ejecutar.html">Validar Firma</a></strong>.</p>
<p>Seleccionamos el fichero del cuál queremos ver la firma:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/valideverificarfirma.png"></p>
<p>Nos sale que también está firmado por Álvaro:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/validefirmaverificada.png"></p>
<p><strong>3. Entre dos compañeros, firmar los dos un documento, verificar la firma para comprobar que está firmado por los dos.</strong></p>
<p>Tanto yo como Álvaro hemos firmado el mismo documento, por tanto si verificamos la firma de éste:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/autofirmafirmadelosdosverificada.png"></p>
<p>Vemos que sale firmado por ambos.</p>
<h4>Tarea 4: Autentificación</h4>
<p><strong>1. Utilizando tu certificado accede a alguna página de la administración pública (cita médica, becas, puntos del carnet,…). Entrega capturas de pantalla donde se demuestre el acceso a ellas.</strong></p>
<p>Voy a intentar consultar mis trámites abiertos en el Ministerio de Educación, utilizando mi certificado digital.</p>
<p>Me dirijo a la web llamada <strong><a href="https://sede.educacion.gob.es/portada.html">Sede Electrónica</a></strong>, y aquí indico que deseo acceder a mis trámites:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/sedeelectronica.png"></p>
<p>Vemos que tenemos distintas posibilidades para identificarnos, yo selecciono <strong>Clave</strong>:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/sedeelectronicaacceso.png"></p>
<p>En esta ventana selecciono <strong>Certificado Electrónico</strong>.</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/sedeelectronicacertdigital.png"></p>
<p>Como tengo instalado mi certificado en este navegador, me lo reconoce automáticamente y me pregunta si quiero acceder:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/sedeelectronicaverificacion.png"></p>
<p>Le digo que sí y automáticamente nos hemos identificado con nuestra certificado digital y nos proporciona la siguiente información:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/sedeelectronicapag.png"></p>
<p>Podemos ver que hemos accedido correctamente y podemos ver la solicitud de mi beca por ejemplo, y que en la parte inferior nos sale un mensaje que nos indica que he accedido mediante clave (certificado digital).</p>
<h2>HTTPS / SSL</h2>
<p><strong>Antes de hacer esta práctica vamos a crear una página web (puedes usar una página estática o instalar una aplicación web) en un servidor web apache2 que se acceda con el nombre <code>tunombre.iesgn.org</code>.</strong></p>
<h4>Tarea 1: Certificado autofirmado</h4>
<p><strong>Esta práctica la vamos a realizar con un compañero. En un primer momento un alumno creará una Autoridad Certificadora y firmará un certificado para la página del otro alumno. Posteriormente se volverá a realizar la práctica con los roles cambiados.</strong></p>
<p><strong>Para hacer esta práctica puedes buscar información en internet, algunos enlaces interesantes:</strong></p>
<ul>
<li><a href="https://www.phildev.net/ssl/">Phil’s X509/SSL Guide</a></li>
<li><a href="https://gist.github.com/Soarez/9688998">How to setup your own CA with OpenSSL</a></li>
<li><a href="https://blog.guillen.io/2018/09/29/crear-autoridad-certificadora-ca-y-certificados-autofirmados-en-linux/">Crear autoridad certificadora (CA) y certificados autofirmados en Linux</a></li>
</ul>
<p><strong>El alumno que hace de Autoridad Certificadora deberá entregar una documentación donde explique los siguientes puntos:</strong></p>
<p><strong>1. Crear su autoridad certificadora (generar el certificado digital de la CA). Mostrar el fichero de configuración de la AC.</strong></p>
<p>Para crear una <strong>Autoridad Certificadora</strong> debemos crear esta estructura de directorios con esta serie de permisos y ficheros:</p>
<pre>
root@https:~# mkdir CA

root@https:~# cd CA/

root@https:~/CA# mkdir ./{certsdb,certreqs,crl,private}

root@https:~/CA# chmod 700 ./private

root@https:~/CA# touch ./index.txt

root@https:~/CA# cp /usr/lib/ssl/openssl.cnf ./

root@https:~/CA# nano openssl.cnf
</pre>

<p>Vemos que hemos copiado el fichero <code>openssl.cnf</code>, y en él tendremos que editar las siguientes líneas y corregir las rutas, para que se use el directorio creado previamente para la Autoridad Certificadora.</p>
<p>En este bloque indicamos que el directorio se encuentra en <code>/root/CA</code>, que los certificados se van a guardar en <code>$dir/certsdb</code>,  la variable <code>$dir</code> ha referencia si nos fijamos a <code>/root/CA</code>, el certificado de la autoridad certificadora se va a encontrar en el directorio con el nombre <code>cacert.pem</code>, ...</p>
<pre>
[ CA_default ]

dir             = /root/CA              # Where everything is kept
certs           = $dir/certsdb          # Where the issued certs are kept
crl_dir         = $dir/crl              # Where the issued crl are kept
database        = $dir/index.txt        # database index file.

                                        # several certs with same subject.
new_certs_dir   = $certs                # default place for new certs.

certificate     = $dir/cacert.pem       # The CA certificate
serial          = $dir/serial           # The current serial number
crlnumber       = $dir/crlnumber        # the current crl number
                                        # must be commented out to leave a V1 CRL
crl             = $dir/crl.pem          # The current CRL
private_key     = $dir/private/cakey.pem# The private key
</pre>

<p>El siguiente bloque a tener en cuenta en el fichero <code>openssl.cnf</code> es el siguiente, y en él vamos a introducir los datos de la autoridad certificadora.</p>
<pre>
[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
countryName_default             = ES
countryName_min                 = 2
countryName_max                 = 2

stateOrProvinceName             = State or Province Name (full name)
stateOrProvinceName_default     = Sevilla

localityName                    = Locality Name (eg, city)
localityName_default            = Dos Hermanas

0.organizationName              = Organization Name (eg, company)
0.organizationName_default      = JavierPerez Corp

organizationalUnitName          = Organizational Unit Name (eg, section)
organizationalUnitName_default  = Informatica

commonName                      = Common Name (e.g. server FQDN or YOUR name)
commonName_max                  = 64

emailAddress                    = Email Address
emailAddress_max                = 64
</pre>

<p>Ya nos encontramos frente al último bloque a editar en este fichero <code>openssl.cnf</code>, y simplemente se trata de buscar las siguientes líneas y comentarlas, ya que a mí no me interesan, esto es según las necesidades y lo que busque cada uno:</p>
<pre>
[ req_attributes ]
#challengePassword              = A challenge password
#challengePassword_min          = 4
#challengePassword_max          = 20

#unstructuredName               = An optional company name
</pre>

<p>Una vez tenemos creada nuestra autoridad certificadora, vamos a generar una</p>
<pre>
root@https:~/CA# openssl req -new -newkey rsa:2048 -keyout private/cakey.pem -out careq.pem -config ./openssl.cnf
Generating a RSA private key
............................................+++++
..............................................................................+++++
writing new private key to 'private/cakey.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [ES]:
State or Province Name (full name) [Sevilla]:
Locality Name (eg, city) [Dos Hermanas]:
Organization Name (eg, company) [JavierPerez Corp]:
Organizational Unit Name (eg, section) [Informatica]:
Common Name (e.g. server FQDN or YOUR name) []:javier.debian
Email Address []:javierperezhidalgo01@gmail.com

root@https:~/CA#
</pre>

<pre>
root@https:~/CA# openssl ca -create_serial -out cacert.pem -days 365 -keyfile private/cakey.pem -selfsign -extensions v3_ca -config ./openssl.cnf -infiles careq.pem
Using configuration from ./openssl.cnf
Enter pass phrase for private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            0a:7b:37:65:ef:20:c3:8c:e9:00:00:d2:54:7c:35:69:7c:0b:29:3d
        Validity
            Not Before: Nov 17 18:43:27 2020 GMT
            Not After : Nov 17 18:43:27 2021 GMT
        Subject:
            countryName               = ES
            stateOrProvinceName       = Sevilla
            organizationName          = JavierPerez Corp
            organizationalUnitName    = Informatica
            commonName                = javier.debian
            emailAddress              = javierperezhidalgo01@gmail.com
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                92:F5:19:9E:24:0D:30:B0:83:14:FA:D5:74:BC:25:79:0F:9F:19:CD
            X509v3 Authority Key Identifier:
                keyid:92:F5:19:9E:24:0D:30:B0:83:14:FA:D5:74:BC:25:79:0F:9F:19:CD

            X509v3 Basic Constraints: critical
                CA:TRUE
Certificate is to be certified until Nov 17 18:43:27 2021 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

root@https:~/CA#
</pre>

<p><strong>2. Debe recibir el fichero CSR (Solicitud de Firmar un Certificado) de su compañero, debe firmarlo y enviar el certificado generado a su compañero.</strong></p>
<p>He creado un usuario llamado <code>alvaro</code>.</p>
<pre>
cp /home/javi/javierpzh_key.pem /certreqs
</pre>

<pre>
root@https:~/CA# openssl ca -config openssl.cnf -out certsdb/alvaro.crt -infiles certreqs/alvaro.csr
Using configuration from openssl.cnf
Enter pass phrase for /root/CA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            0a:7b:37:65:ef:20:c3:8c:e9:00:00:d2:54:7c:35:69:7c:0b:29:3e
        Validity
            Not Before: Nov 17 18:48:00 2020 GMT
            Not After : Nov 17 18:48:00 2021 GMT
        Subject:
            countryName               = ES
            stateOrProvinceName       = Sevilla
            organizationName          = JavierPerez Corp
            organizationalUnitName    = Informatica
            commonName                = alvaro.iesgn.org
            emailAddress              = avacaferreras@gmail.com
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            Netscape Comment:
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier:
                6C:6E:4C:23:03:A7:E9:64:DC:0B:F3:5B:79:97:9A:2C:BE:FB:3D:22
            X509v3 Authority Key Identifier:
                keyid:92:F5:19:9E:24:0D:30:B0:83:14:FA:D5:74:BC:25:79:0F:9F:19:CD

Certificate is to be certified until Nov 17 18:48:00 2021 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

root@https:~/CA#
</pre>

<p>El fichero <em>.crt</em> obtenido, que es el fichero firmado por mi autoridad certificadora, se lo copio a Álvaro al usuario que he creado para él.</p>
<pre>
root@https:~/CA# cp certsdb/alvaro.crt /home/alvaro/
</pre>

<p><strong>3. ¿Qué otra información debes aportar a tu compañero para que éste configure de forma adecuada su servidor web con el certificado generado?</strong></p>
<p>Como yo estoy actuando como Autoridad Certificadora, le tengo que enviar a Álvaro el certificado de la entidad certificadora. Al igual que su <em>.crt</em>, se lo dejo en el usuario de mi máquina que he creado para que acceda él.</p>
<pre>
root@https:~/CA# cp cacert.pem /home/alvaro/
</pre>

<p>Por tanto, una vez hecho esto, Álvaro ya podría visualizar su página con <em>https</em>.</p>
<p><strong>El alumno que hace de administrador del servidor web, debe entregar una documentación que describa los siguientes puntos:</strong></p>
<p><strong>1. Crea una clave privada RSA de 4096 bits para identificar el servidor.</strong></p>
<p>Lo primero que hay que hacer es generar una clave privada:</p>
<pre>
root@https:~# openssl genrsa 4096 > /etc/ssl/private/javi.key
Generating RSA private key, 4096 bit long modulus (2 primes)
................................................................................................................................................++++
............................++++
e is 65537 (0x010001)

root@https:~#
</pre>

<p><strong>2. Utiliza la clave anterior para generar un CSR, considerando que deseas acceder al servidor tanto con el FQDN (<code>tunombre.iesgn.org</code>) como con el nombre de host (implica el uso de las extensiones <code>Alt Name</code>).</strong></p>
<p>Con la clave generada anteriormente, voy a generar un fichero <code>.csr</code> que tendré que enviar a Álvaro para que él me devuelva un fichero <code>.crt</code> firmado por su Autoridad Certificadora, con el cuál yo podré disponer de <strong>https</strong> en mi sitio web.</p>
<p>A la hora de generar el fichero <code>.csr</code> indico en los parámetros que previamente ha configurado Álvaro a la hora de crear su CA, los valores que me corresponden a mí, respetando los apartados, <strong>Organization Name</strong> y <strong>Organizational Unit Name</strong>, que debo poner los valores que Álvaro haya especificado en el fichero <em>openssl.cnf</em> de su Autoridad Certificadora.</p>
<pre>
root@https:~# openssl req -new -key /etc/ssl/private/javi.key -out ./javi.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:Sevilla
Locality Name (eg, city) []:Dos Hermanas
Organization Name (eg, company) [Internet Widgits Pty Ltd]:AlvaroVaca Corp
Organizational Unit Name (eg, section) []:Informatica
Common Name (e.g. server FQDN or YOUR name) []:javierpzh.iesgn.org
Email Address []:javierperezhidalgo01@gmail.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

root@https:~#
</pre>

<p><strong>3. Envía la solicitud de firma a la entidad certificadora (su compañero).</strong></p>
<p>Álvaro también me ha creado un usuario en su máquina, al cuál yo tengo acceso, para que le envíe mi fichero <em>.csr</em>, y próximamente pueda copiarme, el fichero <em>.crt</em> que me devuelva junto con el certificado de su CA, a mi máquina.</p>
<p>Le envío mi <em>.csr</em>:</p>
<pre>
root@https:~# scp javi.csr javi@172.22.200.186:/home/javi/
javi@172.22.200.186's password:
javi.csr                                                              100% 1801   980.4KB/s   00:00
</pre>

<p><strong>4. Recibe como respuesta un certificado X.509 para el servidor firmado y el certificado de la autoridad certificadora.</strong></p>
<p>Copio de la máquina de Álvaro el fichero <em>.crt</em> y el llamado <em>cacert.pem</em> que es el certificado de su autoridad certificadora.</p>
<pre>
root@https:~# scp javi@172.22.200.186:/home/javi/javier.crt ./
javi@172.22.200.186's password:
javier.crt                                                            100% 6284     1.9MB/s   00:00

root@https:~/CA# scp javi@172.22.200.186:/home/javi/cacert.pem ./
javi@172.22.200.186's password:
cacert.pem                                                            100% 4658     1.7MB/s   00:00
</pre>

<p><strong>5. Configura tu servidor web con <em>https</em> en el puerto 443, haciendo que las peticiones <em>http</em> se redireccionen a <em>https</em> (forzar <em>https</em>).</strong></p>
<p>Lo primero que debemos hacer, como estamos trabajando en el <em>cloud</em>, es decir, en <em>OpenStack</em>, sería abrir el puerto <strong>443</strong>, que corresponde a <strong>https</strong>.</p>
<p>Lo abro:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/puerto443.png"></p>
<p>Hecho esto, tenemos que almacenar los ficheros <em>.crt</em> y <em>.pem</em> en la ruta <code>/etc/ssl/certs/</code>, por tanto los movemos:</p>
<pre>
root@https:~# ls
CA  javi.csr  javier.crt  cacert.pem

root@https:~# mv cacert.pem /etc/ssl/certs/

root@https:~# mv javier.crt /etc/ssl/certs/
</pre>

<p>Tenemos que configurar <em>Apache</em> para que utilice los ficheros necesarios y verifique y fuerce el <em>https</em>. Primero vamos a editar el fichero de configuración del <em>virtualhost</em> de la página que hemos creado, y vamos a crear una redirección a <em>https</em> para que siempre accedamos por aquí. Introduzco esta línea:</p>
<pre>
Redirect / https://javierpzh.iesgn.org/
</pre>

<p>El fichero de configuración de mi <em>virtualhost</em> quedaría así:</p>
<pre>
<\VirtualHost *:80>

        ServerName javierpzh.iesgn.org

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        Redirect / https://javierpzh.iesgn.org/

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

<\/VirtualHost>
</pre>

<p><strong>Atención:</strong> a esta configuración hay que eliminarle los carácteres \, que he tenido que introducir para escapar los carácteres siguientes, así que en caso de querer copiar la configuración, debemos tener en cuenta esto.</p>
<p>Si nos fijamos en la ruta del <strong>DocumentRoot</strong>, vemos que he almacenado la página en <code>/var/www/html</code>, esto no es lo adecuado pero como solo estoy haciendo estas pruebas y realmente esta estructura no va a tener ninguna funcionalidad en un futuro, lo hago así por comodidad y rapidez. Recomiendo usar la ruta <code>/srv/www/...</code> para almacenar datos de sitios webs.</p>
<p>Ahora, en el fichero de configuración de la página con <em>https</em>, debemos introducir una serie de líneas como estas:</p>
<ul>
<li><strong>SSLCertificateFile:</strong> indica donde se encuentra nuestro fichero <em>.crt</em> firmado por la autoridad.</li>
<li><strong>SSLCertificateKeyFile:</strong> indica donde se encuentra nuestra clave privada mediante la cuál generemos el archivo <em>.csr</em>.</li>
<li><strong>SSLCertificateChainFile:</strong> indica donde se encuentra el certificado de la autoridad certificadora.</li>
</ul>
<pre>
...

        ServerAdmin webmaster@localhost

        ServerName javierpzh.iesgn.org

        DocumentRoot /var/www/html

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        SSLEngine on

        SSLCertificateFile  /etc/ssl/certs/javier.crt
        SSLCertificateKeyFile /etc/ssl/private/javi.key

    SSLCertificateChainFile /etc/ssl/private/cacert.pem

...
</pre>

<p>Una vez configurado, debemos habilitar la página e iniciar el <strong>módulo SSL</strong> de <em>Apache</em>:</p>
<pre>
root@https:/etc/apache2/sites-available# a2ensite default-ssl.conf

root@https:/etc/apache2/sites-available# a2enmod ssl

root@https:/etc/apache2/sites-available# systemctl restart apache2
</pre>

<p>Ya tendríamos nuestro sitio web configurado para que utilice <em>https</em> pero en nuestro navegador no poseemos el certificado de la autoridad certificadora que nos ha firmado, por tanto debemos añadir su certificado.</p>
<p>Para instalar el certificado en nuestro navegador, <em>Firefox</em> en mi caso, nos dirigimos a <strong>Preferencias</strong>, a la sección <strong>Privacidad &amp; Seguridad</strong>, y al apartado <strong>Certificados</strong>, <em>clickamos</em> en <strong>Ver certificados</strong> y nos sale una ventana como esta:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/caalvaroimportar.png"></p>
<p>Seleccionamos <strong>Importar ...</strong>, e importamos el fichero <em>cacert.pem</em>:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/caalvaroconfiar.png"></p>
<p>Ya hemos importado el certificado de la entidad de Álvaro:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/caalvaroinstalado.png"></p>
<p>Si ahora nos dirigimos a la dirección <code>javierpzh.iesgn.org</code>:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/httpsapache.png"></p>
<p>Vemos que nos ha redirigido automáticamente por <em>https</em> y además podemos ver como tenemos la confianza de la entidad de Álvaro.</p>
<p><strong>6. Instala ahora un servidor Nginx, y realiza la misma configuración que anteriormente para que se sirva la página con <em>HTTPS</em>.</strong></p>
<p>Vamos realizar el mismo proceso pero con un servidor web <strong>Nginx</strong>. En este proceso, voy a ser más directo y voy a utilizar los mismos ficheros que en el apartado anterior, ya que únicamente nos hace falta configurar <em>Nginx</em>.</p>
<p>En primer lugar vamos a parar el servicio de <em>Apache</em>:</p>
<pre>
systemctl stop apache2
</pre>

<p>Instalamos <em>Nginx</em>:</p>
<pre>
apt install nginx -y
</pre>

<p>Editamos el fichero <em>virtualhost</em> por defecto (aunque lo recomendable es crear un <em>virtualhost</em> diferente) y le forzamos a que utilice <em>https</em> y queda con este aspecto:</p>
<pre>
server {
    listen 80;
    server_name javierpzh.iesgn.org;
    return 301 https://$host$request_uri;
}

server {
     listen 443;

    server_name javierpzh.iesgn.org;

    root /var/www/html;

    index index.html index.htm index.nginx-debian.html;

    ssl on;
    ssl_certificate /etc/ssl/certs/javier.crt;
    ssl_certificate_key /etc/ssl/private/javi.key;

    location / {
        try_files $uri $uri/ =404;
    }

}
</pre>

<p>Nos aseguramos que esté habilitado para <em>Nginx</em>:</p>
<pre>
root@https:/etc/nginx/sites-available# ls -l /etc/nginx/sites-enabled/
total 0
lrwxrwxrwx 1 root root 34 Nov 21 12:32 default -> /etc/nginx/sites-available/default
</pre>

<p>Si no lo está, lo habilitamos:</p>
<pre>
ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/
</pre>

<p>Reiniciamos el servicio:</p>
<pre>
systemctl restart nginx.service
</pre>

<p>En el navegador nos introducimos la dirección <code>javierpzh.iesgn.org</code>:</p>
<p><img alt="." src="images/sad_certificados_digitales_HTTPS/httpsnginx.png"></p>
<p>Vemos que nos ha redirigido automáticamente por <em>https</em> y además podemos ver como tenemos la confianza de la entidad de Álvaro, esta vez utilizando un servidor web <em>Nginx</em>.</p>
    </article>

        <div class="tags">
            <p><strong><a href="/tags">tags:</a></strong> <a href="/tag/criptografia.html">Criptografía</a>, <a href="/tag/certificado-digital.html">Certificado digital</a>, <a href="/tag/https.html">HTTPS</a>, <a href="/tag/ssl.html">SSL</a>, <a href="/tag/apache.html">Apache</a>, <a href="/tag/nginx.html">Nginx</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://www.instagram.com/javierpzh/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/jperezhid_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/javierpzh">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.facebook.com/javier.perezhidalgo.904">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:javierperezhidalgo01@gmail.com">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-envelope-square fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog creado por <a href="http://www.instagram.com/javierpzh/">Javier Pérez Hidalgo</a>,
    con la utilización de <a href="https://blog.getpelican.com/">Pelican</a>. <br />        &copy;  Javier Pérez Hidalgo
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

</body>

</html>