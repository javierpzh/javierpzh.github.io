<!DOCTYPE html>
<html lang="es">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Implantación de aplicaciones web PHP en Docker | Javier Pérez Hidalgo</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="En este artículo voy a realizar el despliegue de varias aplicaciones web escritas en PHP en contenedores Docker. Todos los ficheros...">

        <meta name="author" content="Javier Pérez Hidalgo">

        <meta name="tags" content="Docker">
        <meta name="tags" content="PHP">
        <meta name="tags" content="contenedores">
        <meta name="tags" content="BookMedik">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Javier Pérez Hidalgo">

	<meta property="og:type" content="article">
            <meta property="article:author" content="/author/javier-perez-hidalgo.html">
	<meta property="og:url" content="/implantacion-de-aplicaciones-web-php-en-docker.html">
	<meta property="og:title" content="Implantación de aplicaciones web PHP en Docker">
	<meta property="article:published_time" content="2018-03-06 00:00:00+01:00">
            <meta property="og:description" content="En este artículo voy a realizar el despliegue de varias aplicaciones web escritas en PHP en contenedores Docker. Todos los ficheros...">

            <meta property="og:image" content="theme/images/banner-docker.png">
</head>

<body class="article-implantacion-de-aplicaciones-web-php-en-docker">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
        <!--    <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>-->
                <a class="navbar-brand" href="/">Inicio</a>
                <a class="navbar-brand" href="/categories">Categorías</a>
                <a class="navbar-brand" href="/authors">Sobre mí</a>

            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/banner-docker.png')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Implantación de aplicaciones web PHP en Docker</h1>
                        <span class="meta">Publicado por
                                <a href="/author/javier-perez-hidalgo.html">Javier Pérez Hidalgo</a>
                             el mar 06 marzo 2018
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>En este artículo voy a realizar el despliegue de varias aplicaciones web escritas en <strong>PHP</strong> en contenedores <strong>Docker</strong>.</p>
<p>Todos los ficheros necesarios y utilizados, se pueden encontrar en <a href="https://github.com/javierpzh/Implantacion-de-aplicaciones-web-PHP-en-Docker">este repositorio</a> de <em>GitHub</em>.</p>
<p>En todos los apartados utilizaremos dos directorios, el llamado <code>build</code>, destinado a la construcción, y el segundo directorio, <code>deploy</code>, utilizado para el despliegue.</p>
<h4>Ejecución de la aplicación BookMedik en Docker</h4>
<p>En este primer apartado, vamos a ver como sería el proceso para ejecutar la aplicación <strong>BookMedik</strong> en contenedores <em>Docker</em>.</p>
<p>En primer lugar, nos situamos en el directorio <code>build</code> y en él, clonaremos el siguiente <a href="https://github.com/evilnapsis/bookmedik">repositorio</a> que contiene la aplicación <strong>BookMedik</strong>.</p>
<p>Hecho esto, nos dirigiremos a nuestro directorio de despliegue, y en él crearemos nuestro fichero <code>docker-compose.yaml</code>, que inicialmente va a poseer este contenido:</p>
<pre>
version: "3.1"

services:

  db:
    container_name: bookmedik-mysql
    image: mariadb
    restart: always
    environment:
      MYSQL_DATABASE: bookmedik
      MYSQL_USER: bookmedik
      MYSQL_PASSWORD: bookmedik
      MYSQL_ROOT_PASSWORD: javier
    volumes:
      - /home/javier/Docker/Volumes:/var/lib/mysql
</pre>

<p>Podemos apreciar como hemos definido el despliegue de un contenedor llamado <strong>bookmedik-mysql</strong> basado en una imagen <strong>mariadb</strong>. Como podremos imaginar, este contenedor será el encargado de ejecutar nuestra base de datos. Vamos a crearlo ejecutando el siguiente comando:</p>
<pre>
javier@debian:~/Docker/Implantacion-de-aplicaciones-web-PHP-en-Docker/Tarea1/deploy$ docker-compose up -d
Creating bookmedik-mysql ... done
</pre>

<p>Bien, ya habríamos generado nuestro primer contenedor, ahora, necesitaremos ejecutar el siguiente <em>script</em> que se encargará de crear las tablas/datos imprescindibles para nuestra aplicación. Este <em>script</em> se encuentra dentro del repositorio clonado anteriormente y recibe el nombre <code>schema.sql</code>. Antes de volcar las instrucciones en nuestra base de datos, debemos comentar la siguiente línea que se encuentra al inicio de este <em>script</em>:</p>
<pre>
create database bookmedik;
</pre>

<p>Esto debemos hacerlo, ya que, al crear el primer contenedor que ejecuta <em>MySQL</em>, ya hemos creado una base de datos con este nombre.</p>
<p>Hecho esto, podríamos ejecutar el <em>script</em>:</p>
<pre>
javier@debian:~/Docker/Implantacion-de-aplicaciones-web-PHP-en-Docker/Tarea1/deploy$ cat ../build/bookmedik/schema.sql | docker exec -i bookmedik-mysql /usr/bin/mysql -u bookmedik --password=bookmedik bookmedik
</pre>

<p>En este punto, ya disponemos de nuestra base de datos totalmente operativa, por lo que tan sólo nos faltaría crear el contenedor que ejecutará la aplicación. Para ello, crearemos en el directorio <code>build</code>, el siguiente fichero <code>Dockerfile</code>:</p>
<pre>
FROM debian
MAINTAINER Javier Pérez "javierperezhidalgo01@gmail.com"

EXPOSE 80

ADD bookmedik /var/www/html/
ADD script.sh /usr/local/bin/

RUN apt-get update && apt-get install -y apache2 \
libapache2-mod-php7.3 \
php7.3 \
php7.3-mysql \
&& apt-get clean \
&& rm -rf /var/lib/apt/lists/* \
&& chmod +x /usr/local/bin/script.sh

ENV DATABASE_USER bookmedik
ENV DATABASE_PASSWORD bookmedik
ENV DATABASE_HOST db

ENTRYPOINT ["script.sh"]
</pre>

<p>Por último, en la misma ruta, crearemos un fichero llamado <code>script.sh</code> con las siguientes líneas:</p>
<pre>
#!/bin/bash

sed -i 's/$this->user="root";/$this->user="'${DATABASE_USER}'";/g' /var/www/html/core/controller/Database.php
sed -i 's/$this->pass="";/$this->pass="'${DATABASE_PASSWORD}'";/g' /var/www/html/core/controller/Database.php
sed -i 's/$this->host="localhost";/$this->host="'${DATABASE_HOST}'";/g' /var/www/html/core/controller/Database.php

apache2ctl -D FOREGROUND
</pre>

<p>Esto nos ayudará a la hora de la asignación de variables.</p>
<p>Pues ya estaría todo listo, por lo que procederíamos a crear la imagen que posteriormente ejecutará el contenedor de la aplicación:</p>
<pre>
javier@debian:~/Docker/Implantacion-de-aplicaciones-web-PHP-en-Docker/Tarea1/build$ docker build -t javierpzh/bookmedik:v1 .
Sending build context to Docker daemon  5.774MB
Step 1/10 : FROM debian
 ---> 5890f8ba95f6
Step 2/10 : MAINTAINER Javier Pérez "javierperezhidalgo01@gmail.com"
 ---> Running in 597b0e74a1af
Removing intermediate container 597b0e74a1af
 ---> 2bd74e1c46ca
Step 3/10 : EXPOSE 80
 ---> Running in a626d30acc3a
Removing intermediate container a626d30acc3a
 ---> d5e3b4c5a31a
Step 4/10 : ADD bookmedik /var/www/html/
 ---> e3d721661a67
Step 5/10 : ADD script.sh /usr/local/bin/
 ---> 77688c1696ce
Step 6/10 : RUN apt-get update && apt-get install -y apache2 libapache2-mod-php7.3 php7.3 php7.3-mysql && apt-get clean && rm -rf /var/lib/apt/lists/* && chmod +x /usr/local/bin/script.sh
 ---> Running in 5c9ea292ceb8

 ...

 ---> 217f10aad8e5
Step 7/10 : ENV DATABASE_USER bookmedik
 ---> Running in 33177718555b
Removing intermediate container 33177718555b
 ---> 5c1d72d0d8f7
Step 8/10 : ENV DATABASE_PASSWORD bookmedik
 ---> Running in a81a444faa65
Removing intermediate container a81a444faa65
 ---> e50d8477e7ae
Step 9/10 : ENV DATABASE_HOST db
 ---> Running in 6d5caa1033d8
Removing intermediate container 6d5caa1033d8
 ---> 7a385cbb8132
Step 10/10 : ENTRYPOINT ["script.sh"]
 ---> Running in 4b6348f07a94
Removing intermediate container 4b6348f07a94
 ---> 58e4b5c7dcee
Successfully built 58e4b5c7dcee
Successfully tagged javierpzh/bookmedik:v1
</pre>

<p>Finalizado el proceso, vamos a ver que efectivamente nos ha creado la nueva imagen:</p>
<pre>
javier@debian:~/Docker/Implantacion-de-aplicaciones-web-PHP-en-Docker/Tarea1/build$ docker images
REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE
javierpzh/bookmedik   v1                  58e4b5c7dcee        33 seconds ago      251MB
</pre>

<p>¡Bien! Disponemos de la nueva imagen, por lo que tan sólo nos quedaría crear el contenedor que ejecutará <em>BookMedik</em>. Para ello, añadiremos al fichero <code>docker-compose.yaml</code>, que creamos anteriormente en el directorio <code>deploy</code>, el siguiente bloque:</p>
<pre>
  bookmedik:
    container_name: bookmedik
    image: javierpzh/bookmedik:v1
    restart: always
    ports:
      - 8080:80
    volumes:
      - /home/javier/Docker/Volumes:/var/log/apache2
</pre>

<p>Podemos apreciar como hemos definido un nuevo despliegue, en este caso, se trata de un contenedor llamado <strong>bookmedik</strong> basado en la imagen creada, y que va a <em>mapear</em> puertos para que podamos acceder desde nuestro navegador en el puerto 8080. Vamos a crearlo ejecutando el siguiente comando:</p>
<pre>
javier@debian:~/Docker/Implantacion-de-aplicaciones-web-PHP-en-Docker/Tarea1/deploy$ docker-compose up -d
Creating bookmedik-mysql ...
Creating bookmedik ... done
</pre>

<p>Bien, ya habríamos generado nuestro segundo contenedor, por lo que, en teoría, ya dispondríamos de nuestra aplicación. Antes de dirigirnos a nuestro navegador, vamos a listar los contenedores que poseemos activos:</p>
<pre>
javier@debian:~/Docker/Implantacion-de-aplicaciones-web-PHP-en-Docker/Tarea1/deploy$ docker ps
CONTAINER ID        IMAGE                    COMMAND                  CREATED             STATUS              PORTS                  NAMES
5dc207e7d56a        javierpzh/bookmedik:v1   "script.sh"              35 seconds ago      Up 33 seconds       0.0.0.0:8080->80/tcp   bookmedik
aef84a1160f0        mariadb                  "docker-entrypoint.s…"   5 minutes ago       Up 5 minutes        3306/tcp               bookmedik-mysql
</pre>

<p>Efectivamente se están ejecutando los dos contenedores, por lo que es el momento de a acceder a la dirección <code>127.0.0.1:8080</code>:</p>
<p><img alt="." src="images/iaw_implantación_de_aplicaciones_web_PHP_en_Docker/bookmedik1.png"></p>
<p>Vamos a <em>loguearnos</em> mediante las credenciales por defecto: <strong>admin/admin</strong>.</p>
<p><img alt="." src="images/iaw_implantación_de_aplicaciones_web_PHP_en_Docker/bookmedik2.png"></p>
<p>¡Bien! Vemos como nos muestra la aplicación <em>BookMedik</em> por lo que habríamos finalizado este apartado.</p>
<h4>Creando la imagen de BookMedik a partir de la imagen PHP</h4>
<p>.</p>
    </article>

        <div class="tags">
            <p><strong><a href="/tags">tags:</a></strong> <a href="/tag/docker.html">Docker</a>, <a href="/tag/php.html">PHP</a>, <a href="/tag/contenedores.html">contenedores</a>, <a href="/tag/bookmedik.html">BookMedik</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://www.instagram.com/javierpzh/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/jperezhid_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/javierpzh">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.facebook.com/javier.perezhidalgo.904">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:javierperezhidalgo01@gmail.com">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-envelope-square fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog creado por <a href="http://www.instagram.com/javierpzh/">Javier Pérez Hidalgo</a>,
    con la utilización de <a href="https://blog.getpelican.com/">Pelican</a>. <br />        &copy;  Javier Pérez Hidalgo
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

</body>

</html>