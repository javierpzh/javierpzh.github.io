<!DOCTYPE html>
<html lang="es">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Servidor de correos | Javier Pérez Hidalgo</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="En este post vamos a instalar y configurar de manera adecuada un servidor de correos en una VPS alojada en OVH. Mi dominio es...">

        <meta name="author" content="Javier Pérez Hidalgo">

        <meta name="tags" content="Correos">
        <meta name="tags" content="postfix">
        <meta name="tags" content="dovecot">
        <meta name="tags" content="imap">
        <meta name="tags" content="imaps">
        <meta name="tags" content="SMTPS">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Javier Pérez Hidalgo">

	<meta property="og:type" content="article">
            <meta property="article:author" content="/author/javier-perez-hidalgo.html">
	<meta property="og:url" content="/servidor-de-correos.html">
	<meta property="og:title" content="Servidor de correos">
	<meta property="article:published_time" content="2018-02-19 00:00:00+01:00">
            <meta property="og:description" content="En este post vamos a instalar y configurar de manera adecuada un servidor de correos en una VPS alojada en OVH. Mi dominio es...">

            <meta property="og:image" content="theme/images/banner-servicios.jpg">
</head>

<body class="article-servidor-de-correos">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
        <!--    <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>-->
                <a class="navbar-brand" href="/">Inicio</a>
                <a class="navbar-brand" href="/categories">Categorías</a>
                <a class="navbar-brand" href="/authors">Sobre mí</a>

            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/banner-servicios.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Servidor de correos</h1>
                        <span class="meta">Publicado por
                                <a href="/author/javier-perez-hidalgo.html">Javier Pérez Hidalgo</a>
                             el lun 19 febrero 2018
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>En este <em>post</em> vamos a instalar y configurar de manera adecuada un servidor de correos en una <strong>VPS</strong> alojada en <strong>OVH</strong>. Mi dominio es <code>iesgn15.es</code>. El nombre del servidor de correo será <code>mail.iesgn15.es</code> (este es el nombre que deberá aparecer en el registro MX).</p>
<h4>Instalación</h4>
<p>Para comenzar el artículo vamos a instalar las utilidades principales que necesitamos para crear nuestro servidor de correos. Empezaremos por instalar los paquetes <code>postfix</code> y <code>bsd-mailx</code> que corresponden al servidor y a las utilidades del cliente respectivamente.</p>
<pre>
apt install postfix bsd-mailx -y
</pre>

<p>Comencemos.</p>
<h4>Gestión de correos desde el servidor</h4>
<p><strong>1. Vamos a enviar un correo desde nuestro servidor local al exterior (Gmail).</strong></p>
<p>Antes de realizar este ejercicio, vamos a crear un registro de tipo <strong>SPF</strong> en nuestro DNS de OVH, esto le servirá a <strong>Gmail</strong> para identificar que nuestro correo no es <strong>Spam</strong>. He creado el siguiente registro:</p>
<p><img alt="." src="images/sri_servidor_de_correos/registrospf.png"></p>
<p>Ahora vamos a probar a enviar un correo electrónico desde nuestro servidor local, para ello haremos uso de la herramienta <code>mail</code>:</p>
<pre>
debian@vpsjavierpzh:~$ mail javierperezhidalgo01@gmail.com
Subject: Correo de prueba       
Este es el correo de prueba enviado desde mi servidor local
Cc:
</pre>

<p>Parece que ya hemos enviado el correo, pero para asegurarnos vamos a visualizar los <em>logs</em> de nuestro servidor, que se encuentran en el fichero <code>/var/log/mail.log</code>:</p>
<pre>
...
Jan 21 10:24:22 vpsjavierpzh postfix/pickup[24623]: A492F101017: uid=1000 from=<\debian\>
Jan 21 10:24:22 vpsjavierpzh postfix/cleanup[25286]: A492F101017: message-id=<\20210121092422.A492F101017@vpsjavierpzh.iesgn15.es\>
Jan 21 10:24:22 vpsjavierpzh postfix/qmgr[9341]: A492F101017: from=<\debian@iesgn15.es\>, size=488, nrcpt=1 (queue active)
Jan 21 10:24:30 vpsjavierpzh postfix/smtp[25289]: A492F101017: to=<\javierperezhidalgo01@gmail.com\>, relay=gmail-smtp-in.l.google.com[173.194.76.26]:25, delay=7.8, delays=0.05/0.01/0.26/7.5, dsn=2.0.0, status=sent (250 2.0.0 OK  1611221070 h17si4006834wmq.57 - gsmtp)
Jan 21 10:24:30 vpsjavierpzh postfix/qmgr[9341]: A492F101017: removed
...
</pre>

<p>Podemos observar que nos muestra una serie de mensajes de los que podemos sacar que hemos enviado un correo desde <code>debian@iesgn15.es</code> hacia <code>javierperezhidalgo01@gmail.com</code> y que el estado es <em>sent</em>, por lo que en teoría el correo debería haber llegado correctamente. Si nos dirigimos a la bandeja de entrada del correo <code>javierperezhidalgo01@gmail.com</code>:</p>
<p><img alt="." src="images/sri_servidor_de_correos/correorecibidogmail.png"></p>
<p><img alt="." src="images/sri_servidor_de_correos/correorecibidogmailinfo.png"></p>
<p>Vemos que efectivamente hemos recibido el correo procedente de <code>debian@iesgn15.es</code>.</p>
<p>Antes de terminar, vamos a analizar más a fondo el código del correo, para ello hacemos <em>click</em> en <em>Mostrar original</em>:</p>
<pre>
...
Received-SPF: pass (google.com: domain of debian@iesgn15.es designates 51.210.105.17 as permitted sender) client-ip=51.210.105.17;
...
</pre>

<p>En estas líneas se aprecia como ha pasado correctamente y ha hecho uso del registro <strong>SPF</strong> y por tanto no nos muestra este mensaje como <em>Spam</em>.</p>
<p><strong>2. Vamos a enviar un correo desde el exterior (Gmail) a nuestro servidor local.</strong></p>
<p>Al igual que en la tarea anterior, antes de realizar este ejercicio, vamos a crear un registro de tipo <strong>MX</strong> en nuestro DNS de OVH. He creado el siguiente registro:</p>
<p><img alt="." src="images/sri_servidor_de_correos/registromx.png"></p>
<p>Hecho esto, vamos a enviar un correo desde <strong>Gmail</strong> hacia <code>debian@iesgn15.es</code>:</p>
<p><img alt="." src="images/sri_servidor_de_correos/correoenviadogmail.png"></p>
<p>Una vez enviado, vamos a comprobar que lo hayamos recibido en nuestro servidor local, para ello vamos a visualizar de nuevo los <em>logs</em> del fichero <code>/var/log/mail.log</code>:</p>
<pre>
Jan 21 10:45:32 vpsjavierpzh postfix/smtpd[25717]: connect from mail-io1-f43.google.com[209.85.166.43]
Jan 21 10:45:33 vpsjavierpzh postfix/smtpd[25717]: 35244101016: client=mail-io1-f43.google.com[209.85.166.43]
Jan 21 10:45:33 vpsjavierpzh postfix/cleanup[25726]: 35244101016: message-id=<CAMu5ax_BkYemDjV=A1yf1wrDBZ6w_tHZ0Ws+tnPX+3k2TF5ghw@mail.gmail.com>
Jan 21 10:45:33 vpsjavierpzh postfix/qmgr[9341]: 35244101016: from=<javierperezhidalgo01@gmail.com>, size=2643, nrcpt=1 (queue active)
Jan 21 10:45:33 vpsjavierpzh postfix/local[25727]: 35244101016: to=<debian@iesgn15.es>, relay=local, delay=0.02, delays=0.01/0.01/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
Jan 21 10:45:33 vpsjavierpzh postfix/qmgr[9341]: 35244101016: removed
Jan 21 10:45:33 vpsjavierpzh postfix/smtpd[25717]: disconnect from mail-io1-f43.google.com[209.85.166.43] ehlo=2 starttls=1 mail=1 rcpt=1 bdat=1 quit=1 commands=7
You have mail in /var/mail/debian
</pre>

<p>Vaya, parece que tenemos un nuevo correo procedente de la dirección <code>javierperezhidalgo01@gmail.com</code> y lo ha almacenado en la ruta <code>/var/mail/debian</code>, así que vamos a verificarlo.</p>
<p>Para leer los nuevos correos, haremos uso de la herramienta <code>mail</code>.</p>
<pre>
debian@vpsjavierpzh:~$ mail
Mail version 8.1.2 01/15/2001.  Type ? for help.
"/var/mail/debian": 1 message 1 new
\>N  1 javierperezhidalg  Thu Jan 21 10:45   54/2768  Correo de prueba
& 1
</pre>

<p>Vemos que nos indica que tenemos un correo sin leer, si indicamos su número y lo leemos:</p>
<pre>
Message 1:
From javierperezhidalgo01@gmail.com  Thu Jan 21 10:45:33 2021
X-Original-To: debian@iesgn15.es

...

Subject: Correo de prueba
To: debian@iesgn15.es
Content-Type:

...

Este es el correo de prueba enviado desde Gmail

...
</pre>

<p>Efectivamente hemos recibido el correo.</p>
<p>Una vez leído, salimos del programa y vemos que guarda el correo en la dirección <code>/home/debian/mbox</code>:</p>
<pre>
& q
Saved 1 message in /home/debian/mbox
</pre>

<p>Explicado esto, vamos a pasar con el siguiente ejercicio.</p>
<h4>Uso de alias y redirecciones</h4>
<p><strong>3. Uso de alias y redirecciones.</strong></p>
<p>Vamos a comprobar como los procesos del servidor pueden mandar correos para informar sobre su estado. Por ejemplo cada vez que se ejecuta una tarea <code>cron</code> podemos enviar un correo informando del resultado. Normalmente estos correos se mandan al usuario <strong>root</strong> del servidor, para ello:</p>
<pre>
crontab -e
</pre>

<p>E indico donde se envía el correo:</p>
<pre>
MAILTO = root
</pre>

<p>Voy a añadir una nueva tarea en el <em>cron</em> para ver como se manda el correo cuando se lleve dicha tarea. Añado la siguiente línea a mi <em>crontab</em>:</p>
<pre>
40 18 * * * apt update && apt upgrade -y
</pre>

<p>Esta tarea lo que hará básicamente es una actualización de todos los paquetes que haya instalados en el sistema, y se llevará a cabo todos los días a las 18:40.</p>
<p>Al cerrar y guardar nuestro <em>crontab</em> apreciaremos la siguiente salida que indica que hemos realizado cambios en él:</p>
<pre>
root@vpsjavierpzh:~# crontab -e
crontab: installing new crontab
</pre>

<p>Aún queda algo de tiempo hasta las 18:40, lo que me da margen para configurar una serie de <strong>alias</strong> y <strong>redirecciones</strong> para hacer llegar esos correos a nuestro correo personal.</p>
<p>En primer lugar vamos a configurar un nuevo <strong>alias</strong>, para que los correos que tengan como destinatario al usuario <strong>root</strong>, también lleguen al buzón del usuario <strong>debian</strong>. Para ello vamos a editar el fichero <code>/etc/aliases</code> y añadiremos la siguiente línea:</p>
<pre>
root: debian
</pre>

<p>De manera que el contenido total del fichero <code>/etc/aliases</code> sería:</p>
<pre>
# See man 5 aliases for format
postmaster:    root
root: debian
</pre>

<p>Cuando se modifica este fichero, debemos ejecutar el siguiente comando para aplicar los cambios:</p>
<pre>
newaliases
</pre>

<p>Hecho esto, vamos a enviar un correo desde <strong>Gmail</strong> hacia <code>root@iesgn15.es</code>:</p>
<p><img alt="." src="images/sri_servidor_de_correos/correoenviadogmailparareenvioadebian.png"></p>
<p>Una vez enviado, vamos a comprobar que lo hayamos recibido en nuestro servidor local, en el usuario <strong>debian</strong>. Para leer los nuevos correos, haremos uso de la herramienta <code>mail</code> en el usuario <em>debian</em>.</p>
<pre>
debian@vpsjavierpzh:~$ mail
Mail version 8.1.2 01/15/2001.  Type ? for help.
"/var/mail/debian": 2 messages 2 new
...
\>N  2 javierperezhidalg  Tue Feb  2 13:53   54/2752  =?UTF-8?Q?prueba_de_reenv=C3=ADo?=
 & 2
</pre>

<p>Vemos que nos indica que tenemos dos correos sin leer (el primero es una prueba), si indicamos su número, en este caso el 2, y lo leemos:</p>
<pre>
Message 2:
From javierperezhidalgo01@gmail.com  Tue Feb  2 13:53:29 2021
X-Original-To: root@iesgn15.es

...

Subject: =?UTF-8?Q?prueba_de_reenv=C3=ADo?=
To: root@iesgn15.es
Content-Type:

...

hola, llega al usuario debian?

...
</pre>

<p>Efectivamente hemos recibido el correo en el usuario <em>debian</em> y podemos apreciar que el destinatario del correo es <strong>root</strong>, por tanto el alias está bien configurado.</p>
<p>Pasamos a realizar una redirección. Las redirecciones se utilizan para enviar los correos que lleguen a un usuario, a una cuenta de correo externa. Para usuarios reales, las redirecciones se definen en el fichero <code>~/.forward</code> y el formato de este fichero es simplemente un listado de cuentas de correo a las que se quiere redirigir el correo.</p>
<p>En mi caso, creo dicho fichero en el usuario <strong>debian</strong> e introduzco una dirección de correo externa distinta de la que va a enviar el correo:</p>
<pre>
reyole111@gmail.com
</pre>

<p>Hecho esto, vamos a enviar un correo desde <strong>Gmail</strong> hacia <code>root@iesgn15.es</code>:</p>
<p><img alt="." src="images/sri_servidor_de_correos/correoenviadogmailparareenvioadebianygmail.png"></p>
<p>Supuestamente, lo que ahora debería ocurrir es lo siguiente. El correo cuyo destinatario es <strong>root</strong>, debe llegar a <strong>debian</strong>, lo cuál es señal de que el alias está actuando correctamente, y automáticamente después, el correo debe ser reenviado a la dirección <strong>reyole111@gmail.com</strong>.</p>
<p>Vamos a ver si hemos recibido el correo en la bandeja de entrada de <strong>reyole111@gmail.com</strong>.</p>
<p><img alt="." src="images/sri_servidor_de_correos/correorecibidogmailreyole.png"></p>
<p><img alt="." src="images/sri_servidor_de_correos/correorecibidogmailreyoleinfo.png"></p>
<p>Efectivamente, también hemos recibido el correo en la dirección <em>reyole111@gmail.com</em>, por tanto la redirección está bien configurada.</p>
<p>¿Recordáis que teníamos programada una tarea en el <em>cron</em> para las 18:40? Bien, pues resulta que acabo de recibir en <code>reyole111@gmail.com</code> el siguiente correo:</p>
<p><img alt="." src="images/sri_servidor_de_correos/correocron.png"></p>
<p>Se puede apreciar la salida de los comandos que indiqué en la tarea del <em>cron</em>, por lo que, además de ver como nuestro <em>cron</em> nos ha notificado por correo, podemos ver que una vez más han actuado tanto el alias como la redirección configurada.</p>
<h4>Para luchar contra el SPAM</h4>
<p><strong>4. Vamos a configurar <code>Postfix</code> para que tenga en cuenta el registro <em>SPF</em> de los correos que recibe.</strong></p>
<p>En primer lugar, necesitaremos instalar el paquete <code>postfix-policyd-spf-python</code>:</p>
<pre>
apt install postfix-policyd-spf-python -y
</pre>

<p>Una vez instalado, en el fichero <code>/etc/postfix/master.cf</code> debemos crear un <em>socket UNIX</em> que será el encargado de realizar la comprobación. Para ello introduciremos la siguiente línea:</p>
<pre>
policyd-spf  unix  -       n       n       -       0       spawn     user=policyd-spf argv=/usr/bin/policyd-spf
</pre>

<p>Para terminar, debemos editar el fichero <code>/etc/postfix/main.cf</code> y en él, indicaremos que haga uso de dicho <em>socket UNIX</em>. Añadimos esta línea:</p>
<pre>
policyd-spf_time_limit = 3600
smtpd_recipient_restrictions = check_policy_service unix:private/policyd-spf
</pre>

<p>Hecho esto, aplicaremos los cambios reiniciando el servicio:</p>
<pre>
systemctl restart postfix
</pre>

<p>Vamos a hacer la prueba visualizando los <em>logs</em> y enviando un nuevo correo desde <em>Gmail</em>:</p>
<pre>
root@vpsjavierpzh:~# tail -f /var/log/mail.log
Feb 19 19:14:21 vpsjavierpzh postfix/smtpd[19227]: connect from mail-io1-f42.google.com[209.85.166.42]
Feb 19 19:14:22 vpsjavierpzh policyd-spf[19234]: prepend Received-SPF: Pass (mailfrom) identity=mailfrom; client-ip=209.85.166.42; helo=mail-io1-f42.google.com; envelope-from=javierperezhidalgo01@gmail.com; receiver=<UNKNOWN>
Feb 19 19:14:22 vpsjavierpzh postfix/smtpd[19227]: 7ED0310115E: client=mail-io1-f42.google.com[209.85.166.42]
Feb 19 19:14:22 vpsjavierpzh postfix/cleanup[19237]: 7ED0310115E: message-id=<CAMu5ax89DXzEtwWTeLm-OmDK18zXgXDocqiuk0XLn+9OnAu3cA@mail.gmail.com>
Feb 19 19:14:22 vpsjavierpzh postfix/qmgr[19197]: 7ED0310115E: from=<javierperezhidalgo01@gmail.com>, size=2710, nrcpt=1 (queue active)
Feb 19 19:14:22 vpsjavierpzh postfix/cleanup[19237]: 81C7710115F: message-id=<CAMu5ax89DXzEtwWTeLm-OmDK18zXgXDocqiuk0XLn+9OnAu3cA@mail.gmail.com>
Feb 19 19:14:22 vpsjavierpzh postfix/qmgr[19197]: 81C7710115F: from=<javierperezhidalgo01@gmail.com>, size=2845, nrcpt=1 (queue active)
Feb 19 19:14:22 vpsjavierpzh postfix/local[19238]: 7ED0310115E: to=<root@iesgn15.es>, relay=local, delay=0.36, delays=0.35/0.01/0/0, dsn=2.0.0, status=sent (forwarded as 81C7710115F)
Feb 19 19:14:22 vpsjavierpzh postfix/qmgr[19197]: 7ED0310115E: removed
Feb 19 19:14:22 vpsjavierpzh postfix/smtpd[19227]: disconnect from mail-io1-f42.google.com[209.85.166.42] ehlo=2 starttls=1 mail=1 rcpt=1 bdat=1 quit=1 commands=7
</pre>

<p>Podemos ver como ahora si está llevando a cabo la comprobación del registro <em>SPF</em>.</p>
<hr>
<p><strong>5. Vamos a configurar un sistema <em>antispam</em>.</strong></p>
<p>En este apartado vamos a ver como instalar un sistema <em>antispam</em> en nuestro servidor de correos. Para ello necesitaremos instalar los siguientes paquetes:</p>
<pre>
apt install spamc spamassassin -y
</pre>

<p>Una vez instalados, habilitaremos e iniciaremos el servicio:</p>
<pre>
systemctl enable spamassassin && systemctl start spamassassin
</pre>

<p>Posteriormente, nos dirigiremos al fichero <code>/etc/postfix/master.cf</code> y añadiremos las siguientes líneas para que tenga en cuenta el sistema que implementaremos a continuación:</p>
<pre>
smtp      inet  n       -       y       -       -       smtpd
-o content_filter=spamassassin

submission inet n       -       y       -       -       smtpd
-o content_filter=spamassassin

spamassassin unix -     n       n       -       -       pipe
  user=debian-spamd argv=/usr/bin/spamc -f -e /usr/sbin/sendmail -oi -f ${sender} ${recipient}
</pre>

<p>Por último, tendremos que configurar <strong>Spamassassin</strong>. Su configuración es bastante simple y se llevará a cabo en el fichero <code>/etc/spamassassin/local.cf</code>. En él necesitaremos descomentar la siguiente línea, ya que por defecto aparece comentada:</p>
<pre>
rewrite_header Subject *****SPAM*****
</pre>

<p>Realizados todas las modificaciones, aplicaremos los cambios reiniciando ambos servicios:</p>
<pre>
systemctl restart postfix
systemctl restart spamassassin
</pre>

<p>Llegó el momento de realizar la prueba, enviaremos un correo desde <em>Gmail</em></p>
<pre>

</pre>

<hr>
<p><strong>6. Vamos a configurar un sistema antivirus.</strong></p>
<p>En este apartado vamos a ver como instalar un sistema antivirus en nuestro servidor de correos. En mi caso, voy a utilizar un antivirus llamado <strong>clamAV</strong>, que se instala mediante los siguientes paquetes:</p>
<pre>
apt install clamav clamav-freshclam clamsmtp -y
</pre>

<p>Una vez instalados, habilitaremos e iniciaremos el servicio:</p>
<pre>
systemctl enable clamsmtp && systemctl start clamsmtp
</pre>

<p>Posteriormente, nos dirigiremos al fichero <code>/etc/postfix/main.cf</code> y añadiremos las siguientes líneas:</p>
<pre>
content_filter = scan:127.0.0.1:10025
receive_override_options = no_address_mappings
</pre>

<p>También tendremos que editar el fichero <code>/etc/postfix/master.cf</code> y añadir las líneas siguientes. Estas líneas nos servirán para indicarle a nuestro servidor de correos, donde debe llevar a cabo las consultas referentes sobre si los diferentes correos llevan algún virus o no.</p>
<pre>
scan      unix  -       -       n       -       16      smtp
        -o smtp_send_xforward_command=yes

127.0.0.1:10026      inet  n       -       n       -       16      smtpd
        -o content_filter=
        -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
        -o smtpd_helo_restrictions=
        -o smtpd_client_restrictions=
        -o smtpd_sender_restrictions=
        -o smtpd_recipient_restrictions=permit_mynetworks,reject
        -o mynetworks_style=host
        -o smtpd_authorized_xforward_hosts=127.0.0.0/8
</pre>

<p>Por último, tendremos que configurar <em>clamAV</em>. Su configuración se llevará a cabo en el fichero <code>/etc/clamsmtpd.conf</code>. En él necesitaremos establecer los siguientes valores en los apartados <code>OutAddress</code> y <code>Listen</code>:</p>
<pre>
OutAddress: 10026
...
Listen: 127.0.0.1:10025
</pre>

<p>Realizados todas las modificaciones, aplicaremos los cambios reiniciando ambos servicios:</p>
<pre>
systemctl restart postfix
systemctl restart clamsmtp
</pre>

<pre>

</pre>

<h4>Gestión de correos desde un cliente</h4>
<p><strong>7. Vamos a configurar el buzón de los usuarios de tipo <code>Maildir</code>. Envía un correo a tu usuario y comprueba que el correo se ha guardado en el buzón <code>Maildir</code> del usuario del sistema correspondiente. Recuerda que ese tipo de buzón no se puede leer con la utilidad <code>mail</code>.</strong></p>
<p>Como ya sabemos, por defecto al instalar <em>Postfix</em>, estaremos utilizando el formato <strong>mbox</strong> para almacenar los correos electrónicos, pero, ¿como hacemos para cambiar al formato <strong>Maildir</strong>?</p>
<p>Primeramente vamos a ver que diferencias encontramos entre los dos.</p>
<ul>
<li>
<p><strong>mbox:</strong> guarda todos los mensajes en un solo archivo.</p>
</li>
<li>
<p><strong>Maildir:</strong> utiliza un directorio, con subdirectorios, para guardar los mensajes en ficheros individuales.</p>
</li>
</ul>
<p>Explicado esto, vamos a proceder a configurar <em>Postfix</em> para que empiece a utilizar el formato <em>Maildir</em>.</p>
<p>En primer lugar, nos dirigimos al fichero <code>/etc/postfix/main.cf</code> e introduciremos la siguiente línea en él:</p>
<pre>
home_mailbox = Maildir/
</pre>

<p>(Es importante la <code>/</code> final.)</p>
<p>Hecho esto, ya habremos configurado <em>Postfix</em> para que utilice <em>Maildir</em>, por tanto vamos a reiniciar el servicio y a hacer una prueba para comprobar el cambio.</p>
<pre>
systemctl restart postfix
</pre>

<p><strong>8. Instalar y configurar <code>dovecot</code> para ofrecer el protocolo <code>IMAP</code>. Vamos a configurar <code>dovecot</code> para ofrecer autentificación y cifrado. Para realizar el cifrado de la comunicación crea un certificado en <em>LetsEncrypt</em> para el dominio <code>mail.iesgn15.es</code>. Recuerda que para el ofrecer el cifrado tiene varias soluciones:</strong></p>
<ul>
<li>
<p>IMAP con STARTTLS: STARTTLS transforma una conexión insegura en una segura mediante el uso de SSL/TLS. Por lo tanto usando el mismo puerto 143/tcp tenemos cifrada la comunicación.</p>
</li>
<li>
<p>IMAPS: Versión segura del protocolo IMAP que usa el puerto 993/tcp.
Ofrecer las dos posibilidades.</p>
</li>
</ul>
<p>Elige una de las opciones anterior para realizar el cifrado. Y muestra la configuración de un cliente de correo (evolution, thunderbird, …) y muestra como puedes leer los correos enviado a tu usuario.</p>
<p><strong>9. Instala un webmail (roundcube, horde, rainloop) para gestionar el correo del equipo mediante una interfaz web. Muestra la configuración necesaria y cómo eres capaz de leer los correos que recibe tu usuario.</strong></p>
<p><strong>10. Configura de manera adecuada <code>postfix</code> para que podamos mandar un correo desde un cliente remoto. La conexión entre cliente y servidor debe estar autentificada con SASL usando <code>dovecot</code> y además debe estar cifrada. Para cifrar esta comunicación puedes usar dos opciones:</strong></p>
<ul>
<li>
<p>ESMTP + STARTTLS: Usando el puerto 567/tcp enviamos de forma segura el correo al servidor.</p>
</li>
<li>
<p>SMTPS: Utiliza un puerto no estándar (465) para SMTPS (Simple Mail Transfer Protocol Secure). No es una extensión de smtp. Es muy parecido a HTTPS.</p>
</li>
</ul>
<p>Elige una de las opciones anterior para realizar el cifrado. Y muestra la configuración de un cliente de correo (evolution, thunderbird, …) y muestra como puedes enviar los correos.</p>
<p><strong>11. Configura el cliente webmail para el envío de correo. Realiza una prueba de envío con el webmail.</strong></p>
<h4>Comprobación final</h4>
<p><strong>12. Prueba de envío de correo. En <a href="https://www.mail-tester.com/">www.mail-tester.com/</a> tenemos una herramienta completa y fácil de usar a la que podemos enviar un correo para que verifique y puntúe el correo que enviamos. Captura la pantalla y muestra la puntuación que has sacado.</strong></p>
<p>.</p>
    </article>

        <div class="tags">
            <p><strong><a href="/tags">tags:</a></strong> <a href="/tag/correos.html">Correos</a>, <a href="/tag/postfix.html">postfix</a>, <a href="/tag/dovecot.html">dovecot</a>, <a href="/tag/imap.html">imap</a>, <a href="/tag/imaps.html">imaps</a>, <a href="/tag/smtps.html">SMTPS</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://www.instagram.com/javierpzh/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/jperezhid_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/javierpzh">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.facebook.com/javier.perezhidalgo.904">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:javierperezhidalgo01@gmail.com">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-envelope-square fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog creado por <a href="http://www.instagram.com/javierpzh/">Javier Pérez Hidalgo</a>,
    con la utilización de <a href="https://blog.getpelican.com/">Pelican</a>. <br />        &copy;  Javier Pérez Hidalgo
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

</body>

</html>