<!DOCTYPE html>
<html lang="es">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Sistema de ficheros "avanzados" Btrfs | Javier Pérez Hidalgo</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Elige uno de los dos sistemas de ficheros "avanzados". Crea un escenario que incluya una máquina y varios discos asociados a ella....">

        <meta name="author" content="Javier Pérez Hidalgo">

        <meta name="tags" content="FileSystem">
        <meta name="tags" content="Btrfs">
        <meta name="tags" content="Compresión">
        <meta name="tags" content="CoW">
        <meta name="tags" content="Copy on Write">
        <meta name="tags" content="Deduplicación">
        <meta name="tags" content="Cifrado">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Javier Pérez Hidalgo">

	<meta property="og:type" content="article">
            <meta property="article:author" content="/author/javier-perez-hidalgo.html">
	<meta property="og:url" content="/sistema-de-ficheros-avanzados-btrfs.html">
	<meta property="og:title" content="Sistema de ficheros "avanzados" Btrfs">
	<meta property="article:published_time" content="2021-01-22 00:00:00+01:00">
            <meta property="og:description" content="Elige uno de los dos sistemas de ficheros "avanzados". Crea un escenario que incluya una máquina y varios discos asociados a ella....">

            <meta property="og:image" content="theme/images/banner-hlc.jpg">
</head>

<body class="article-sistema-de-ficheros-avanzados-btrfs">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
        <!--    <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>-->
                <a class="navbar-brand" href="/">Inicio</a>
                <a class="navbar-brand" href="/categories">Categorías</a>
                <a class="navbar-brand" href="/authors">Sobre mí</a>

            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/banner-hlc.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Sistema de ficheros "avanzados" Btrfs</h1>
                        <span class="meta">Publicado por
                                <a href="/author/javier-perez-hidalgo.html">Javier Pérez Hidalgo</a>
                             el vie 22 enero 2021
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>Elige uno de los dos sistemas de ficheros "avanzados".</p>
<ul>
<li>
<p>Crea un escenario que incluya una máquina y varios discos asociados a ella.</p>
</li>
<li>
<p>Instala si es necesario el software de Btrfs</p>
</li>
<li>
<p>Gestiona los discos adicionales con Btrfs</p>
</li>
<li>
<p>Configura los discos en RAID, haciendo pruebas de fallo de algún disco y sustitución, restauración del RAID. Comenta ventajas e inconvenientes respecto al uso de RAID software con <code>mdadm</code>.</p>
</li>
<li>
<p>Realiza ejercicios con pruebas de funcionamiento de las principales funcionalidades: compresión, cow, deduplicación, cifrado, etc.</p>
</li>
</ul>
<p>Esta tarea se puede realizar en una instancia de OpenStack y documentarla como habitualmente o bien grabar un vídeo con una demo de las características y hacer la entrega con el enlace del vídeo.</p>
<hr>
<p>En este <em>post</em> vamos a ver el sistema de ficheros <strong>Btrfs</strong>.</p>
<h4>Características</h4>
<p><strong>Btrfs</strong> <em>(B-tree FS)</em> es un sistema de archivos <strong>copy-on-write</strong> <em>(CoW)</em> anunciado por <em>Oracle Corporation</em> para <em>GNU/Linux</em>. <em>Btrfs</em> existe porque los desarrolladores querían expandir la funcionalidad de un sistema de archivos para incluir funcionalidades adicionales tales como agrupación, instantáneas y sumas de verificación.</p>
<p>El proyecto comenzó en <em>Oracle</em>, pero desde entonces, otras compañías importantes han desempeñado un papel en el desarrollo, como pueden ser <em>Facebook</em>, <em>Intel</em>, <em>Netgear</em>, <em>Red Hat</em> y <em>SUSE</em>.</p>
<p>Veamos algunas características de este sistema de ficheros:</p>
<ul>
<li>
<p>2^64 bytes = 16 EiB <em>(Exbibyte)</em> tamaño máximo de archivo</p>
</li>
<li>
<p>Empaquetado eficiente en espacio de archivos pequeños y directorios indexados</p>
</li>
<li>
<p>Asignación dinámica de inodos (no se fija un número máximo de archivos al crear el sistema de archivos)</p>
</li>
<li>
<p><em>Snapshots</em> escribibles y <em>snapshots</em> de <em>snapshots</em></p>
</li>
<li>
<p>Subvolúmenes</p>
</li>
<li>
<p><em>Mirroring</em> y <em>Striping</em> a nivel de objeto</p>
</li>
<li>
<p>Comprobación de datos y metadatos</p>
</li>
<li>
<p>Compresión</p>
</li>
<li>
<p><em>Copy-on-write</em> del registro de todos los datos y metadatos</p>
</li>
<li>
<p>Gran integración con <em>device-mapper</em> para soportar múltiples dispositivos, con varios algoritmos de RAID incluidos</p>
</li>
<li>
<p>Comprobación del sistema de archivos sin desmontar y comprobación muy rápida del sistema de archivos desmontado</p>
</li>
<li>
<p>Copias de seguridad incrementales eficaces y <em>mirroring</em> del sistema de archivos</p>
</li>
<li>
<p>Modo optimizado para SSD</p>
</li>
<li>
<p>Desfragmentación sin desmontar</p>
</li>
</ul>
<h4>Escenario de trabajo</h4>
<p>Para empezar a trabajar con este sistema de ficheros, he creado un escenario en <em>OpenStack</em> que se resume en una instancia con <em>Debian</em>, a la que le he añadido tres volúmenes de 1 GB cada uno, como podemos observar aquí:</p>
<pre>
root@btrfs:~# lsblk
NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda    254:0    0   2G  0 disk
└─vda1 254:1    0   2G  0 part /
vdb    254:16   0   1G  0 disk
vdc    254:32   0   1G  0 disk
vdd    254:48   0   1G  0 disk
</pre>

<p>Pasemos con la instalación.</p>
<h4>Instalación</h4>
<p>Para instalar <em>Btrfs</em> en nuestro sistema <em>Debian</em>, tenemos disponible el paquete <strong>btrfs-tools</strong>, que incluye todas las herramientas y características de este sistema de ficheros.</p>
<pre>
apt install btrfs-tools -y
</pre>

<p>Ya habremos instalado las herramientas.</p>
<h4>Gestión de los discos</h4>
<p>En primer lugar, vamos a formatear uno de estos volúmenes y asignarle como sistema de ficheros <em>Btrfs</em>. Para ello, hacemos uso de la herramienta <code>mkfs.()</code> seguido del dispositivo:</p>
<pre>
root@btrfs:~# mkfs.btrfs /dev/vdb
</pre>

<p>Comprobamos que hemos asignado este <em>filesystem</em> correctamente:</p>
<pre>
root@btrfs:~# lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         9659e5d4-dd87-42af-bf70-0bb6f7b2e31b  846.4M    51% /
vdb    btrfs        800a0dc3-d7d2-433a-8445-69e0d09d99cd                
vdc
vdd
</pre>

<p>Efectivamente ya estaríamos gestionando el dispositivo <code>vdb</code> con <em>Btrfs</em>.</p>
<h4>RAID</h4>
<p>¿Y qué pasa si quisiéramos crear un sistema <strong>RAID</strong> con los 3 nuevos volúmenes? Bien, pues para llevar a cabo esto, nos valdría con introducir el mismo comando que hemos utilizado para formatear un dispositivo, pero indicando los tres discos en este caso.</p>
<p>Esto ocurre ya que <em>Btrfs</em> lo interpreta como un RAID para su gestión aunque no lo estemos indicando. Si queremos indicar el tipo de RAID que debe crear, podemos utilizar los parámetros <code>-d</code> y <code>-m</code> para especificar el perfil de redundancia para los datos y metadatos. En mi caso, voy a crear un RAID 1, que recordemos que se caracteriza por duplicar el almacenamiento de los datos en todos los dispositivos:</p>
<pre>
root@btrfs:~# mkfs.btrfs -d raid1 -m raid1 /dev/vdb /dev/vdc /dev/vdd
btrfs-progs v4.20.1
See http://btrfs.wiki.kernel.org for more information.

/dev/vdb appears to contain an existing filesystem (btrfs).
ERROR: use the -f option to force overwrite of /dev/vdb
</pre>

<p>Al haber utilizado anteriormente el disco <code>vdb</code> nos avisa que ya tiene un sistema de ficheros y que si queremos asignarle nuevamente este <em>filesystem</em>, tendremos que indicar el parámetro <code>-f</code> y de esta manera forzarlo.</p>
<pre>
root@btrfs:~# mkfs.btrfs -f -d raid1 -m raid1 /dev/vdb /dev/vdc /dev/vdd
btrfs-progs v4.20.1
See http://btrfs.wiki.kernel.org for more information.

Label:              (null)
UUID:               1675b6b0-4741-4341-bb5b-403e1e7c2932
Node size:          16384
Sector size:        4096
Filesystem size:    3.00GiB
Block group profiles:
  Data:             RAID1           153.56MiB
  Metadata:         RAID1           153.56MiB
  System:           RAID1             8.00MiB
SSD detected:       no
Incompat features:  extref, skinny-metadata
Number of devices:  3
Devices:
   ID        SIZE  PATH
    1     1.00GiB  /dev/vdb
    2     1.00GiB  /dev/vdc
    3     1.00GiB  /dev/vdd
</pre>

<p>Vemos como efectivamente ahora poseen <em>Btrfs</em>:</p>
<pre>
root@btrfs:~# lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         9659e5d4-dd87-42af-bf70-0bb6f7b2e31b  846.4M    51% /
vdb    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vdc    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vdd    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932
</pre>

<p>Además de poseer este sistema de ficheros, apreciamos como los identificadores de los tres dispositivos son idénticos, esto se debe a que el sistema lo identifica como tan sólo uno.</p>
<p>Os preguntaréis como haríamos para añadir un nuevo disco a este RAID ya existente, antes de verlo, vamos a montar el sistema RAID en nuestro sistema:</p>
<pre>
root@btrfs:~# mount /dev/vdb /mnt/

root@btrfs:~# lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         9659e5d4-dd87-42af-bf70-0bb6f7b2e31b  846.1M    51% /
vdb    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932  734.9M     1% /mnt
vdc    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vdd    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                

root@btrfs:~# btrfs scrub start /mnt/
scrub started on /mnt/, fsid 1675b6b0-4741-4341-bb5b-403e1e7c2932 (pid=640)

root@btrfs:~# btrfs scrub status /mnt/
scrub status for 1675b6b0-4741-4341-bb5b-403e1e7c2932
    scrub started at Mon Jan 18 18:10:43 2021 and finished after 00:00:00
    total bytes scrubbed: 512.00KiB with 0 errors
</pre>

<p>Una vez montado nuestro RAID, vamos a añadir un nuevo dispositivo, en este caso el llamado <code>vde</code>:</p>
<pre>
root@btrfs:~# lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         9659e5d4-dd87-42af-bf70-0bb6f7b2e31b  846.1M    51% /
vdb    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932  581.3M     1% /mnt
vdc    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vdd    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vde
</pre>

<p>Vemos que no posee el sistema <em>Btrfs</em>, y es una unidad nueva, lo añadimos:</p>
<pre>
root@btrfs:~# btrfs device add /dev/vde /mnt/

root@btrfs:~# lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         9659e5d4-dd87-42af-bf70-0bb6f7b2e31b  846.1M    51% /
vdb    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932    1.1G     1% /mnt
vdc    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vdd    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vde    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                

root@btrfs:~# btrfs filesystem show
Label: none  uuid: 1675b6b0-4741-4341-bb5b-403e1e7c2932
    Total devices 4 FS bytes used 320.00KiB
    devid    1 size 1.00GiB used 595.12MiB path /dev/vdb
    devid    2 size 1.00GiB used 665.56MiB path /dev/vdc
    devid    3 size 1.00GiB used 441.56MiB path /dev/vdd
    devid    4 size 1.00GiB used 0.00B path /dev/vde
</pre>

<p>Ya habríamos añadido este nuevo dispositivo pero aún nos faltaría activar el balanceo de carga para que se reparta la información entre los discos, incluyendo el nuevo que hemos añadido.</p>
<pre>
root@btrfs:~# btrfs balance start --full-balance /mnt/
Done, had to relocate 5 out of 5 chunks

root@btrfs:~# btrfs filesystem show
Label: none  uuid: 1675b6b0-4741-4341-bb5b-403e1e7c2932
    Total devices 4 FS bytes used 320.00KiB
    devid    1 size 1.00GiB used 288.00MiB path /dev/vdb
    devid    2 size 1.00GiB used 416.00MiB path /dev/vdc
    devid    3 size 1.00GiB used 256.00MiB path /dev/vdd
    devid    4 size 1.00GiB used 448.00MiB path /dev/vde
</pre>

<p>En este punto, sí se habría añadido completamente el disco y su funcionamiento sería el correcto.</p>
<p>Para seguir, vamos a probar a ver que pasaría en caso de que uno de los discos fallara, por ejemplo el <code>vdd</code>, por tanto, el sistema ya no lo reconoce e identifica un fallo en el sistema RAID, y he añadido el nuevo disco <code>vdf</code> para que sustituya al anterior y así se pueda restaurar el RAID correctamente.</p>
<pre>
root@btrfs:~# lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         9659e5d4-dd87-42af-bf70-0bb6f7b2e31b  846.1M    51% /
vdb    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932    1.5G     1% /mnt
vdc    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vde    btrfs        1675b6b0-4741-4341-bb5b-403e1e7c2932                
vdf

root@btrfs:~# btrfs filesystem show
Label: none  uuid: 1675b6b0-4741-4341-bb5b-403e1e7c2932
    Total devices 4 FS bytes used 256.00KiB
    devid    1 size 1.00GiB used 288.00MiB path /dev/vdb
    devid    2 size 1.00GiB used 32.00MiB path /dev/vdc
    devid    4 size 1.00GiB used 416.00MiB path /dev/vde
    *** Some devices missing
</pre>

<p>Vemos como nos detecta el fallo debido a que falta un dispositivo, y procedemos a sustituirlo:</p>
<pre>
root@btrfs:~# btrfs device add /dev/vdf /mnt/ && btrfs device delete /dev/vdd /mnt/

root@btrfs:~# btrfs filesystem show
Label: none  uuid: 1675b6b0-4741-4341-bb5b-403e1e7c2932
    Total devices 4 FS bytes used 320.00KiB
    devid    1 size 1.00GiB used 288.00MiB path /dev/vdb
    devid    2 size 1.00GiB used 448.00MiB path /dev/vdc
    devid    4 size 1.00GiB used 256.00MiB path /dev/vde
    devid    6 size 1.00GiB used 416.00MiB path /dev/vdf
</pre>

<p>Hecho esto, habríamos resuelto este problema y habríamos sustituido el disco estropeado.</p>
<p>Bien, ¿y si tuviéramos dudas entre elegir RAID mediante <em>Btrfs</em> o mediante la herramienta <code>mdadm</code>, qué diferencia tendríamos entre ellas? Pues para responder esta pregunta es necesario conocer las ventajas y los inconvenientes de cada una de las opciones, así que pasaremos a analizarlas.</p>
<p>Una ventaja de RAID software mediante <code>mdadm</code> es que sencillo de realizar, forma un sistema estable y tiene un mayor rendimiento. Por otro lado, con <em>Btrfs</em> los datos se encuentran protegidos con un mayor sistema de seguridad. Pero sobre todo, la principal diferencia, es que haciendo uso de <em>Btrfs</em>, podemos crear un RAID 1 con discos de diferentes tamaños, incluso con la posibilidad de ampliarlos, mientras que con <code>mdadm</code> es necesario el mismo tamaño en los discos. Por último, una cosa que no he comentado anteriormente y es bastante interesante, es que por ejemplo, hemos montado un RAID 1, que consta de 4 discos de 1 GB cada uno, y conociendo las características de este tipo de RAID, el espacio total sería de 1 GB, como el menor de sus discos, pues vamos a comprobar el tamaño de este RAID:</p>
<pre>
root@btrfs:~# df -h
Filesystem      Size  Used Avail Use% Mounted on

...

/dev/vdb        2.0G   17M  1.7G   1% /mnt
</pre>

<p>¡Anda! Resulta que duplica el tamaño esperado, y esto es porque <em>Btrfs</em> gestiona el almacenamiento de una manera distinta, ya que reparte la información entre los diferentes dispositivos, aprovechando el máximo espacio posible, al mismo tiempo que asegura que la información se encuentra lo más segura posible. Así que imaginemos que creamos un RAID 1 con discos de distintos tamaños, ya no tendríamos el inconveniente de que el tamaño será igual al menor de sus discos.</p>
<p>Lógicamente la elección de uno u otro es algo subjetivo y dependerá de gustos, costumbres y necesidades, pero en resumen, poseemos más flexibilidad y muchas más características útiles en el RAID con <em>Btrfs</em> respecto al RAID con <code>mdadm</code>.</p>
<h4>Compresión</h4>
<p>Como vimos al principio del artículo cuando enumerábamos las características de <em>Btrfs</em>, este sistema de ficheros posee la capacidad para realizar la llamada <strong>compresión al vuelo</strong>, por tanto, en este apartado vamos a realizar algunos ejercicios y pruebas de este funcionamiento.</p>
<p>Antes de empezar, me gustaría explicar un poco que significa este término y para qué nos sirve. Es la posibilidad de almacenar la información comprimida, y en el momento que necesitemos hacer uso de esta información, el propio sistema es capaz de descomprimirla, leerla y acto seguido, volverla a comprimir para almacenarla. Esto nos da la posibilidad de almacenar muchísima más información que la que en un principio podríamos guardar, ya que como sabemos, un archivo comprimido reduce bastante su tamaño original.</p>
<p>Existen dos maneras de compresión al vuelo, que son las llamadas <strong>ZLIB</strong> y <strong>LZO</strong>.</p>
<p>¿Y qué diferencias hay entre estas dos opciones?</p>
<ul>
<li><strong>LZO</strong>: es una compresión mas rápida pero menos exigente, lo que penaliza la capacidad de compresión, es decir, no llega a comprimir tanto la información.</li>
<li><strong>ZLIB</strong>: es más exigente y por ello, comprime más la información, con el <em>hándicap</em> en cuanto a tiempo y en cuanto a la carga de CPU, que es un poco mayor.</li>
</ul>
<p>En mi caso voy a utilizar la opción <em>LZIB</em>. La compresión con esta opción, se lleva a cabo con el siguiente comando:</p>
<pre>
mount -o compress=zlib /dev/(dispositivo) /(punto de montaje)/
</pre>

<p>En mi caso, voy a comprimir el volumen denominado <code>vdb</code>, por lo que utilizo el siguiente comando:</p>
<pre>
mount -o compress=zlib /dev/vdb /mnt/
</pre>

<p>Hay que recordar que esta unidad, pertenece al RAID 1 creado anteriormente, que constaba de 4 discos de 1 GB cada uno, obteniendo un espacio total de <strong>2 GB</strong>:</p>
<pre>
root@btrfs:~# btrfs filesystem show
Label: none  uuid: 1675b6b0-4741-4341-bb5b-403e1e7c2932
    Total devices 4 FS bytes used 256.00KiB
    devid    1 size 1.00GiB used 288.00MiB path /dev/vdb
    devid    2 size 1.00GiB used 448.00MiB path /dev/vdc
    devid    4 size 1.00GiB used 256.00MiB path /dev/vde
    devid    6 size 1.00GiB used 416.00MiB path /dev/vdf
</pre>

<p>Dicho esto, vamos a probar a introducir la máxima información posible, para comprobar que podemos almacenar más espacio del que realmente poseemos gracias a la compresión. Con el siguiente comando vamos crear un fichero lleno de ceros, y posteriormente, miraremos el espacio que realmente ocupa dicho fichero.</p>
<pre>
root@btrfs:~# dd if=/dev/zero of=/mnt/fichero
dd: writing to '/mnt/fichero': No space left on device
113354259+0 records in
113354258+0 records out
58037380096 bytes (58 GB, 54 GiB) copied, 835.45 s, 69.5 MB/s

root@btrfs:~# ls -la /mnt/ && du -h /mnt/
total 56677152
drwxr-xr-x  1 root root          34 Jan 22 16:20 .
drwxr-xr-x 18 root root        4096 Jan 18 18:06 ..
-rw-r--r--  1 root root 58037380096 Jan 22 16:34 fichero

55G /mnt/
</pre>

<p>¡Vaya! Resulta que dicho fichero ocupa alrededor de <strong>55 GB</strong>, cuando el espacio total del RAID era de 2 GB. Por si acaso, vamos a ver de nuevo los detalles de esta unidad:</p>
<pre>
root@btrfs:~# btrfs filesystem show
Label: none  uuid: 1675b6b0-4741-4341-bb5b-403e1e7c2932
    Total devices 4 FS bytes used 1.79GiB
    devid    1 size 1.00GiB used 1023.00MiB path /dev/vdb
    devid    2 size 1.00GiB used 1023.00MiB path /dev/vdc
    devid    4 size 1.00GiB used 1023.00MiB path /dev/vde
    devid    6 size 1.00GiB used 1023.00MiB path /dev/vdf
</pre>

<p>Y efectivamente, estamos almacenando un fichero comprimido de 55 GB, en un espacio real de 1.79 GiB.</p>
<h4>Copy on Write (CoW)</h4>
<p><strong>Copy on Write</strong> conocido también por sus siglas <strong>CoW</strong>, es una optimización que permite almacenar una sola vez copias de datos indistinguibles. Es en el momento en el que una de estas copias se modifica en el que se realiza físicamente la copia. Así, aquellas copias que no llegan a modificarse nunca, solo existen en apariencia y remiten a los datos originales.</p>
<p>Para realizar ejercicios y mostrar el funcionamiento de <em>CoW</em>, voy a eliminar en primer lugar, el fichero creado en el apartado anterior y de esta manera seguir trabajando con la totalidad del RAID, aunque también podría sacar un disco del RAID y trabajar con él, pero prefiero la primera opción.</p>
<pre>
root@btrfs:/mnt# ls
fichero

root@btrfs:/mnt# rm fichero

root@btrfs:/mnt# df -h /mnt
Filesystem      Size  Used Avail Use% Mounted on
/dev/vdb        2.0G   17M  1.7G   1% /mnt
</pre>

<p>En el apartado anterior trabajamos con el RAID, así que vamos a cambiar y ahora simplemente vamos a trabajar con un disco, para ello voy a eliminar el disco <code>vdf</code> del RAID y posteriormente desmontaré el sistema RAID, y montaré el nuevo disco en el sistema:</p>
<pre>
root@btrfs:~# btrfs device delete /dev/vdf /mnt/

root@btrfs:~# btrfs filesystem show
Label: none  uuid: 1675b6b0-4741-4341-bb5b-403e1e7c2932
    Total devices 3 FS bytes used 6.91MiB
    devid    1 size 1.00GiB used 352.00MiB path /dev/vdb
    devid    2 size 1.00GiB used 32.00MiB path /dev/vdc
    devid    4 size 1.00GiB used 320.00MiB path /dev/vde

root@btrfs:~# umount /mnt/

root@btrfs:~# mkfs.btrfs /dev/vdf
btrfs-progs v4.20.1
See http://btrfs.wiki.kernel.org for more information.

Label:              (null)
UUID:               d59c6498-b013-4bd5-bf6e-6e2838ce8894
Node size:          16384
Sector size:        4096
Filesystem size:    1.00GiB
Block group profiles:
  Data:             single            8.00MiB
  Metadata:         DUP              51.19MiB
  System:           DUP               8.00MiB
SSD detected:       no
Incompat features:  extref, skinny-metadata
Number of devices:  1
Devices:
   ID        SIZE  PATH
    1     1.00GiB  /dev/vdf

root@btrfs:~# mount /dev/vdf /mnt/
</pre>

<p>Ahora voy a proceder a crear un fichero que será con el que trabajaremos:</p>
<pre>
root@btrfs:~# dd if=/dev/zero of=/mnt/ficheroprueba bs=2048 count=100k
102400+0 records in
102400+0 records out
209715200 bytes (210 MB, 200 MiB) copied, 2.06027 s, 102 MB/s

root@btrfs:~# ls /mnt/
ficheroprueba

root@btrfs:~# btrfs fi usage /mnt
Overall:
    Device size:           1.00GiB
    Device allocated:        462.38MiB
    Device unallocated:      561.62MiB
    Device missing:          0.00B
    Used:            200.92MiB
    Free (estimated):        705.42MiB  (min: 424.61MiB)
    Data ratio:               1.00
    Metadata ratio:           2.00
    Global reserve:       16.00MiB  (used: 0.00B)

Data,single: Size:344.00MiB, Used:200.20MiB
   /dev/vdf  344.00MiB

Metadata,DUP: Size:51.19MiB, Used:352.00KiB
   /dev/vdf  102.38MiB

System,DUP: Size:8.00MiB, Used:16.00KiB
   /dev/vdf   16.00MiB

Unallocated:
   /dev/vdf  561.62MiB
</pre>

<p>Vemos que el fichero ocupa un espacio de <strong>200 MB</strong>. Bien, ahora vamos a realizar una copia de éste. Le indicamos el parámetro <code>--reflink=always</code> para que nos permita realizar un clon del fichero, es decir, una copia aparente basada en <em>CoW</em>.</p>
<pre>
root@btrfs:~# cp --reflink=always /mnt/ficheroprueba /mnt/ficheropruebaCoW

root@btrfs:~# ls /mnt/
ficheroprueba  ficheropruebaCoW

root@btrfs:~# btrfs fi usage /mnt
Overall:
    Device size:           1.00GiB
    Device allocated:        462.38MiB
    Device unallocated:      561.62MiB
    Device missing:          0.00B
    Used:            200.92MiB
    Free (estimated):        705.42MiB  (min: 424.61MiB)
    Data ratio:               1.00
    Metadata ratio:           2.00
    Global reserve:       16.00MiB  (used: 0.00B)

Data,single: Size:344.00MiB, Used:200.20MiB
   /dev/vdf  344.00MiB

Metadata,DUP: Size:51.19MiB, Used:352.00KiB
   /dev/vdf  102.38MiB

System,DUP: Size:8.00MiB, Used:16.00KiB
   /dev/vdf   16.00MiB

Unallocated:
   /dev/vdf  561.62MiB
</pre>

<p>Apreciamos que el nuevo fichero no ha afectado en absoluto al espacio ocupado del dispositivo, ya que aún no se ha realizado ninguna modificación.</p>
<h4>Deduplicación</h4>
<p>¿En qué consiste la <strong>deduplicación</strong>?</p>
<p>Consiste en identificar cuándo los datos se han escrito dos veces y combinarlos en una misma extensión del disco, con el objetivo de optimizar al máximo el espacio de almacenamiento utilizado, eliminando copias duplicadas o repetidas de datos.</p>
<p>Para hacer uso de la deduplicación de datos debemos instalar el siguiente paquete:</p>
<pre>
apt install duperemove -y
</pre>

<p>Vamos a utilizar de nuevo el dispositivo <code>vdf</code>, para ello voy a formatearlo de nuevo:</p>
<pre>
root@btrfs:~# umount /mnt

root@btrfs:~# mkfs.btrfs -f /dev/vdf
btrfs-progs v4.20.1
See http://btrfs.wiki.kernel.org for more information.

Label:              (null)
UUID:               6e1e1285-8652-445b-b44f-af22438387fc
Node size:          16384
Sector size:        4096
Filesystem size:    1.00GiB
Block group profiles:
  Data:             single            8.00MiB
  Metadata:         DUP              51.19MiB
  System:           DUP               8.00MiB
SSD detected:       no
Incompat features:  extref, skinny-metadata
Number of devices:  1
Devices:
   ID        SIZE  PATH
    1     1.00GiB  /dev/vdf

root@btrfs:~# mount /dev/vdf /mnt/
</pre>

<p>Ahora vamos a crear un fichero de <strong>100 MB</strong>:</p>
<pre>
root@btrfs:~# dd if=/dev/zero of=/mnt/pruebadeduplicacion bs=2048 count=50k
51200+0 records in
51200+0 records out
104857600 bytes (105 MB, 100 MiB) copied, 1.04235 s, 101 MB/s

root@btrfs:~# ls /mnt/
pruebadeduplicacion

root@btrfs:~# du -h /mnt/pruebadeduplicacion
100M    /mnt/pruebadeduplicacion

root@btrfs:~# df -h /mnt
Filesystem      Size  Used Avail Use% Mounted on
/dev/vdf        1.0G  117M  805M  13% /mnt

root@btrfs:~# btrfs fi usage /mnt
Overall:
    Device size:           1.00GiB
    Device allocated:        238.38MiB
    Device unallocated:      785.62MiB
    Device missing:          0.00B
    Used:            100.57MiB
    Free (estimated):        805.55MiB  (min: 412.74MiB)
    Data ratio:               1.00
    Metadata ratio:           2.00
    Global reserve:       16.00MiB  (used: 0.00B)

Data,single: Size:120.00MiB, Used:100.07MiB
   /dev/vdf  120.00MiB

Metadata,DUP: Size:51.19MiB, Used:240.00KiB
   /dev/vdf  102.38MiB

System,DUP: Size:8.00MiB, Used:16.00KiB
   /dev/vdf   16.00MiB

Unallocated:
   /dev/vdf  785.62MiB
</pre>

<p>Una vez creado, apreciamos que en nuestro dispositivo se encuentran en uso <strong>100 MB</strong>, es decir, lo esperado, pero ahora vamos a almacenar una copia del mismo fichero:</p>
<pre>
root@btrfs:~# cp /mnt/pruebadeduplicacion /mnt/pruebadeduplicacion2

root@btrfs:~# ls /mnt
pruebadeduplicacion  pruebadeduplicacion2

root@btrfs:~# df -h /mnt
Filesystem      Size  Used Avail Use% Mounted on
/dev/vdf        1.0G  217M  705M  24% /mnt

root@btrfs:~# btrfs fi usage /mnt
Overall:
    Device size:           1.00GiB
    Device allocated:        350.38MiB
    Device unallocated:      673.62MiB
    Device missing:          0.00B
    Used:            200.88MiB
    Free (estimated):        705.49MiB  (min: 368.68MiB)
    Data ratio:               1.00
    Metadata ratio:           2.00
    Global reserve:       16.00MiB  (used: 0.00B)

Data,single: Size:232.00MiB, Used:200.13MiB
   /dev/vdf  232.00MiB

Metadata,DUP: Size:51.19MiB, Used:368.00KiB
   /dev/vdf  102.38MiB

System,DUP: Size:8.00MiB, Used:16.00KiB
   /dev/vdf   16.00MiB

Unallocated:
   /dev/vdf  673.62MiB
</pre>

<p>Podemos ver como ahora se encuentran en uso <strong>200 MB</strong>.</p>
<p>Es el momento de aplicar la deduplicación, para ello aplicamos el siguiente comando:</p>
<pre>
root@btrfs:~# duperemove -dr /mnt
Gathering file list...
Using 1 threads for file hashing phase
[1/2] (50.00%) csum: /mnt/pruebadeduplicacion
[2/2] (100.00%) csum: /mnt/pruebadeduplicacion2
Total files:  2
Total hashes: 1600
Loading only duplicated hashes from hashfile.
Hashing completed. Using 1 threads to calculate duplicate extents. This may take some time.
[########################################]
Search completed with no errors.             
Simple read and compare of file data found 1 instances of extents that might benefit from deduplication.
Showing 2 identical extents of length 104857600 with id 19b81479
Start       Filename
0   "/mnt/pruebadeduplicacion2"
0   "/mnt/pruebadeduplicacion"
Using 1 threads for dedupe phase
[0x5649765e0c00] (1/1) Try to dedupe extents with id 19b81479
[0x5649765e0c00] Dedupe 1 extents (id: 19b81479) with target: (0, 104857600), "/mnt/pruebadeduplicacion2"
Comparison of extent info shows a net change in shared extents of: 209715200
</pre>

<p>Si observamos la salida del comando, podemos ver como nos hace referencia a ambos ficheros, pero, ¿realmente habremos ahorrado el espacio? Vamos a comprobarlo:</p>
<pre>
root@btrfs:~# ls /mnt
pruebadeduplicacion  pruebadeduplicacion2

root@btrfs:~# df -h /mnt
Filesystem      Size  Used Avail Use% Mounted on
/dev/vdf        1.0G  117M  805M  13% /mnt

root@btrfs:~# btrfs fi usage /mnt
Overall:
    Device size:           1.00GiB
    Device allocated:        238.38MiB
    Device unallocated:      785.62MiB
    Device missing:          0.00B
    Used:            100.62MiB
    Free (estimated):        805.50MiB  (min: 412.69MiB)
    Data ratio:               1.00
    Metadata ratio:           2.00
    Global reserve:       16.00MiB  (used: 0.00B)

Data,single: Size:120.00MiB, Used:100.12MiB
   /dev/vdf  120.00MiB

Metadata,DUP: Size:51.19MiB, Used:240.00KiB
   /dev/vdf  102.38MiB

System,DUP: Size:8.00MiB, Used:16.00KiB
   /dev/vdf   16.00MiB

Unallocated:
   /dev/vdf  785.62MiB
</pre>

<p>¡Bien! Efectivamente la deduplicación ha surgido efecto y tan solo estamos ocupando <strong>100 MB</strong> en nuestro dispositivo gracias a <em>Btrfs</em>.</p>
<h4>Redimensión</h4>
<p>En este apartado vamos a analizar las redimensiones del espacio en dispositivos que disponen de <em>Btrfs</em>.</p>
<p>Empezaremos viendo el caso de disminuir el espacio, para el que tendríamos que utilizar el siguiente comando:</p>
<pre>
root@btrfs:~# btrfs filesystem show /mnt/
Label: none  uuid: 6e1e1285-8652-445b-b44f-af22438387fc
    Total devices 1 FS bytes used 100.31MiB
    devid    1 size 1.00GiB used 238.38MiB path /dev/vdf

root@btrfs:~# btrfs filesystem resize -100M /mnt/
Resize '/mnt/' of '-100M'

root@btrfs:~# btrfs filesystem show /mnt/
Label: none  uuid: 6e1e1285-8652-445b-b44f-af22438387fc
    Total devices 1 FS bytes used 100.31MiB
    devid    1 size 924.00MiB used 238.38MiB path /dev/vdf
</pre>

<p>Hemos reducido el espacio del dispositivo en 100 MB.</p>
<p>Por el contrario, si lo que quisiéramos fuera aumentar el espacio utilizaríamos el mismo comando pero cambiando el signo a <code>+</code>:</p>
<pre>
root@btrfs:~# btrfs filesystem show /mnt/
Label: none  uuid: 6e1e1285-8652-445b-b44f-af22438387fc
    Total devices 1 FS bytes used 100.31MiB
    devid    1 size 924.00MiB used 238.38MiB path /dev/vdf

root@btrfs:~# btrfs filesystem resize +100M /mnt/
Resize '/mnt/' of '+100M'

root@btrfs:~# btrfs filesystem show /mnt/
Label: none  uuid: 6e1e1285-8652-445b-b44f-af22438387fc
    Total devices 1 FS bytes used 100.31MiB
    devid    1 size 1.00GiB used 238.38MiB path /dev/vdf
</pre>

<p>Hemos aumentado el espacio del dispositivo en 100 MB.</p>
<h4>Cifrado</h4>
<p>.
Primero, asegúrese de que el sistema no se encuentra montada:
root #umount <dispositivo_montado></p>
<p>Compruebe la integridad del sistema de ficheros usando la herramienta apropiada de fsck. En el siguiente ejemplo, el sistema de ficheros es ext4:
root #fsck.ext4 -f <dispositivo_desmontado></p>
<p>Use btrfs-convert para convertir el dispositivo con formato ext* a un dispositivo formateado en Btrfs:
root #btrfs-convert <dispositivo_desmontado></p>
<p>Asegúrese de editar el fichero /etc/fstab después de que el dispositivo haya sido formateado para cambiar la columna de sistema de ficheros de ext4 a Btrfs:
.</p>
    </article>

        <div class="tags">
            <p><strong><a href="/tags">tags:</a></strong> <a href="/tag/filesystem.html">FileSystem</a>, <a href="/tag/btrfs.html">Btrfs</a>, <a href="/tag/compresion.html">Compresión</a>, <a href="/tag/cow.html">CoW</a>, <a href="/tag/copy-on-write.html">Copy on Write</a>, <a href="/tag/deduplicacion.html">Deduplicación</a>, <a href="/tag/cifrado.html">Cifrado</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://www.instagram.com/javierpzh/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/jperezhid_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/javierpzh">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.facebook.com/javier.perezhidalgo.904">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:javierperezhidalgo01@gmail.com">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-envelope-square fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog creado por <a href="http://www.instagram.com/javierpzh/">Javier Pérez Hidalgo</a>,
    con la utilización de <a href="https://blog.getpelican.com/">Pelican</a>. <br />        &copy;  Javier Pérez Hidalgo
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

</body>

</html>