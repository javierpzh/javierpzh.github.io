<!DOCTYPE html>
<html lang="es">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Servidor DNS | Javier Pérez Hidalgo</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Escenario En nuestra red local tenemos un servidor Web que sirve dos páginas web: www.iesgn.org, departamentos.iesgn.org. Vamos a...">

        <meta name="author" content="Javier Pérez Hidalgo">

        <meta name="tags" content="DNS">
        <meta name="tags" content="bind9">
        <meta name="tags" content="dnsmasq">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Javier Pérez Hidalgo">

	<meta property="og:type" content="article">
            <meta property="article:author" content="/author/javier-perez-hidalgo.html">
	<meta property="og:url" content="/servidor-dns.html">
	<meta property="og:title" content="Servidor DNS">
	<meta property="article:published_time" content="2020-12-11 00:00:00+01:00">
            <meta property="og:description" content="Escenario En nuestra red local tenemos un servidor Web que sirve dos páginas web: www.iesgn.org, departamentos.iesgn.org. Vamos a...">

            <meta property="og:image" content="theme/images/banner-servicios.jpg">
</head>

<body class="article-servidor-dns">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
        <!--    <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>-->
                <a class="navbar-brand" href="/">Inicio</a>
                <a class="navbar-brand" href="/categories">Categorías</a>
                <a class="navbar-brand" href="/authors">Sobre mí</a>

            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/banner-servicios.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Servidor DNS</h1>
                        <span class="meta">Publicado por
                                <a href="/author/javier-perez-hidalgo.html">Javier Pérez Hidalgo</a>
                             el vie 11 diciembre 2020
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <h3>Escenario</h3>
<ol>
<li>
<p><strong>En nuestra red local tenemos un servidor Web que sirve dos páginas web: <code>www.iesgn.org</code>, <code>departamentos.iesgn.org</code>.</strong></p>
</li>
<li>
<p><strong>Vamos a instalar en nuestra red local un servidor DNS (lo puedes instalar en el mismo equipo que tiene el servidor web).</strong></p>
</li>
<li>
<p><strong>Voy a suponer en este documento que el nombre del servidor DNS va a ser <code>pandora.iesgn.org</code>. El nombre del servidor de tu prácticas será <code>tunombre.iesgn.org</code>.</strong></p>
</li>
</ol>
<h3>Servidor DNSmasq</h3>
<p><strong>Instala el servidor DNS <em>dnsmasq</em> en <code>pandora.iesgn.org</code> y configúralo para que los clientes puedan conocer los nombres necesarios.</strong></p>
<p>He creado una instancia en el <em>cloud</em> de <strong>OpenStack</strong> que será la máquina que actuará como <strong>servidor</strong>, posee una dirección IP <strong>172.22.200.174</strong>.</p>
<p>Las dos páginas servidas por <em>Apache2</em> las he creado pero voy a omitir su explicación, pues ya tengo otras entradas en las que hablo expresamente de esto. Te dejo este enlace por si quieres saber algo más de <a href="https://javierpzh.github.io/tag/apache.html">Apache2</a>.</p>
<p><strong>Importante:</strong> como estamos trabajando en el <em>cloud</em>, he tenido que abrir el puerto <strong>53/UDP</strong>, ya que es el puerto que se utiliza para recibir las peticiones de parte de los clientes.</p>
<p>Una vez en ella, lo primero que debemos hacer es instalar el siguiente paquete:</p>
<pre>
apt install dnsmasq -y
</pre>

<p>Para comenzar a configurar el servidor <em>dnsmasq</em>, empezaremos por descomentar la siguiente línea en el fichero <code>/etc/dnsmasq.conf</code> para que el servidor <em>dnsmasq</em> pueda leer en caso de que sea necesario, es decir, cuando él mismo no pueda resolver una petición, la configuración del fichero <code>/etc/resolv.conf</code>:</p>
<pre>
strict-order
</pre>

<p>En este fichero, también debemos buscar la directiva <strong>interface</strong>, descomentarla y establecerle como valor, la interfaz de red de nuestra máquina, en mi caso es la <strong>eth0</strong>, de manera que el resultado sería este:</p>
<pre>
interface=eth0
</pre>

<p>Con esto, ya habríamos terminado la configuración del servicio <code>dnsmasq</code>.</p>
<p>Vamos a cambiar el nombre de la máquina, para ello, editamos el fichero <code>/etc/hostname</code>. En mi caso la máquina se llamará <code>javierpzh</code> por lo que el contenido del fichero es:</p>
<pre>
javierpzh
</pre>

<p>Si vemos, actualmente el <em>prompt</em> de la máquina posee este aspecto:</p>
<pre>
root@servidor-dns:~#
</pre>

<p>Debemos reiniciar la máquina para que este cambio se aplique, pero antes, vamos a modificar el fichero <code>/etc/hosts</code> para cambiar el <strong>hostname</strong> y el <strong>FQDN</strong> de la máquina.</p>
<p>Antes de hacer esto, por experiencia, ya sé, que al reiniciar la máquina se restablecerá el fichero <code>/etc/hosts</code>. Para cambiar este funcionamiento, tenemos que dirigirnos al fichero <code>/etc/cloud/cloud.cfg</code> y buscar esta línea:</p>
<pre>
manage_etc_hosts: true
</pre>

<p>Le cambiamos el valor a <em>false</em>:</p>
<pre>
manage_etc_hosts: false
</pre>

<p>Ahora sí, vamos a cambiar el fichero <code>/etc/hosts</code>. Nos interesa cambiar la línea con la dirección <strong>127.0.1.1</strong> que es la que hace referencia a la propia máquina. Establezco como <strong>FQDN</strong> <code>javierpzh.iesgn.org</code> y como <strong>hostname</strong>, <code>javierpzh</code>:</p>
<pre>
127.0.1.1 javierpzh.iesgn.org javierpzh
</pre>

<p>Hecho esto, vamos a reiniciar la máquina con el comando <code>reboot</code>.</p>
<p>Si después del reinicio volvemos a mirar el <em>prompt</em>:</p>
<pre>
root@javierpzh:~#
</pre>

<p>Vemos como hemos modificado correctamente el <em>hostname</em> de la máquina.</p>
<p>Vamos a mirar también el <em>FQDN</em>:</p>
<pre>
root@javierpzh:~# hostname
javierpzh

root@javierpzh:~# hostname -f
javierpzh.iesgn.org
</pre>

<p>También lo hemos modificado. Con esto, habríamos terminado todo el trabajo en la máquina <em>servidor</em>.</p>
<h4>Tarea 1: Modifica los clientes para que utilicen el nuevo servidor DNS. Realiza una consulta a <code>www.iesgn.org</code>, y a <code>www.josedomingo.org</code>. Realiza una prueba de funcionamiento para comprobar que el servidor <em>dnsmasq</em> funciona como caché DNS. Muestra el fichero hosts del cliente para demostrar que no estás utilizando resolución estática. Realiza una consulta directa al servidor <em>dnsmasq</em>. ¿Se puede realizar resolución inversa?</h4>
<p>La máquina que actuará como <strong>cliente</strong>, será mi máquina anfitriona.</p>
<p>Una vez en el <em>cliente</em>, vamos a instalar el paquete <code>dnsutils</code>, para poder hacer uso de la herramienta <code>dig</code>:</p>
<pre>
apt install dnsutils -y
</pre>

<p>Una vez instalado este paquete, vamos a añadir en el fichero <code>/etc/resolv.conf</code>, que contiene los servidores DNS que va a utilizar esta máquina, esta línea para indicar que haga uso del servidor DNS que hemos creado:</p>
<pre>
nameserver 172.22.200.174
</pre>

<p>Añadimos la línea <code>nameserver 172.22.200.174</code>, cuya dirección corresponde a la IP de la máquina servidor.</p>
<p>Hecho esto, podemos realizar una consulta a <code>www.iesgn.org</code>:</p>
<pre>
javier@debian:~$ dig www.iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> www.iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 30160
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.iesgn.org.         IN  A

;; ANSWER SECTION:
www.iesgn.org.      0   IN  A   172.22.200.174

;; Query time: 97 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 13:56:32 CET 2020
;; MSG SIZE  rcvd: 58
</pre>

<p>Vemos como nos está respondiendo nuestro servidor DNS, ya que nos indica que la respuesta viene de la IP <strong>172.22.200.174</strong>.</p>
<p>Realizo una consulta a <code>departamentos.iesgn.org</code>:</p>
<pre>
javier@debian:~$ dig departamentos.iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> departamentos.iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 32409
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;departamentos.iesgn.org.   IN  A

;; ANSWER SECTION:
departamentos.iesgn.org. 0  IN  A   172.22.200.174

;; Query time: 242 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 13:57:36 CET 2020
;; MSG SIZE  rcvd: 68
</pre>

<p>Vemos como de nuevo nos está respondiendo nuestro servidor DNS.</p>
<p>Hago una consulta a <code>www.josedomingo.org</code>, la cual me debería responder ya que en el servidor hemos realizado la configuración adecuada para que pueda utilizar DNS externos en caso de que sea necesario:</p>
<pre>
javier@debian:~$ dig www.josedomingo.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> www.josedomingo.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 18210
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 5, ADDITIONAL: 6

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: cd4b754d056f0763b14e40b65fd8b2fa0fe587d46fbb0cd0 (good)
;; QUESTION SECTION:
;www.josedomingo.org.       IN  A

;; ANSWER SECTION:
www.josedomingo.org.    900 IN  CNAME   endor.josedomingo.org.
endor.josedomingo.org.  365 IN  A   37.187.119.60

;; AUTHORITY SECTION:
josedomingo.org.    82635   IN  NS  ns1.cdmon.net.
josedomingo.org.    82635   IN  NS  ns5.cdmondns-01.com.
josedomingo.org.    82635   IN  NS  ns4.cdmondns-01.org.
josedomingo.org.    82635   IN  NS  ns2.cdmon.net.
josedomingo.org.    82635   IN  NS  ns3.cdmon.net.

;; ADDITIONAL SECTION:
ns1.cdmon.net.      160610  IN  A   35.189.106.232
ns2.cdmon.net.      160610  IN  A   35.195.57.29
ns3.cdmon.net.      160610  IN  A   35.157.47.125
ns4.cdmondns-01.org.    82635   IN  A   52.58.66.183
ns5.cdmondns-01.com.    160610  IN  A   52.59.146.62

;; Query time: 700 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 13:58:34 CET 2020
;; MSG SIZE  rcvd: 318
</pre>

<p>Vemos que el tiempo de respuesta ha sido de <strong>700 msec</strong>, algo bastante elevado, aunque supongo que es porque estoy trabajando desde casa a través de la VPN.</p>
<p>Vamos a realizar de nuevo una consulta a <code>www.josedomingo.org</code>, la cual me debería responder más rápida que la anterior ya que este servidor funciona como <strong>caché DNS</strong>:</p>
<pre>
javier@debian:~$ dig www.josedomingo.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> www.josedomingo.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 64502
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.josedomingo.org.       IN  A

;; ANSWER SECTION:
www.josedomingo.org.    846 IN  CNAME   endor.josedomingo.org.
endor.josedomingo.org.  311 IN  A   37.187.119.60

;; Query time: 81 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 13:59:27 CET 2020
;; MSG SIZE  rcvd: 99
</pre>

<p>Vemos que esta vez el tiempo de respuesta ha sido de <strong>81 msec</strong>, muchísimo más reducido que la primera vez, lo que demuestra que este servidor funciona como <em>caché DNS</em>. Además, vuelvo a decir que estoy en casa, si estuviera en clase, seguramente el tiempo de respuesta hubiera sido de unos pocos <em>msec</em>.</p>
<p>Por último, vamos a comprobar la resolución inversa haciendo una consulta a la IP de la dirección <code>endor.josedomingo.org</code> que es la <em>37.187.119.60</em>:</p>
<pre>
javier@debian:~$ dig -x 37.187.119.60

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> -x 37.187.119.60
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 60847
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: ab7414b8c67b8dae299df1475fd8b528f0540c2f00c10f05 (good)
;; QUESTION SECTION:
;60.119.187.37.in-addr.arpa.    IN  PTR

;; ANSWER SECTION:
60.119.187.37.in-addr.arpa. 86370 IN    PTR ns330309.ip-37-187-119.eu.

;; AUTHORITY SECTION:
119.187.37.in-addr.arpa. 172763 IN  NS  ns104.ovh.net.
119.187.37.in-addr.arpa. 172763 IN  NS  dns104.ovh.net.

;; Query time: 230 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:07:52 CET 2020
;; MSG SIZE  rcvd: 170
</pre>

<p>Vemos que nos ha respondido de nuevo nuestro servidor DNS, por lo que también podríamos realizar resoluciones inversas.</p>
<h3>Servidor bind9</h3>
<p><strong>Desinstala el servidor <em>dnsmasq</em> del ejercicio anterior e instala un servidor DNS <em>bind9</em>. Las características del servidor DNS que queremos instalar son las siguientes:</strong></p>
<ul>
<li>
<p><strong>El servidor DNS se llama <code>pandora.iesgn.org</code> y por supuesto, va a ser el servidor con autoridad para la zona <code>iesgn.org</code>.</strong></p>
</li>
<li>
<p><strong>Vamos a suponer que tenemos un servidor para recibir los correos que se llame <code>correo.iesgn.org</code> y que está en la dirección x.x.x.200 (esto es ficticio).</strong></p>
</li>
<li>
<p><strong>Vamos a suponer que tenemos un servidor FTP que se llame <code>ftp.iesgn.org</code> y que está en x.x.x.201 (esto es ficticio).</strong></p>
</li>
<li>
<p><strong>Además queremos nombrar a los clientes.</strong></p>
</li>
<li>
<p><strong>También hay que nombrar a los <em>virtualhosts</em> de apache: <code>www.iesgn.org</code> y <code>departementos.iesgn.org</code>.</strong></p>
</li>
<li>
<p><strong>Se tienen que configurar la zona de resolución inversa.</strong></p>
</li>
</ul>
<h4>Tarea 2: Realiza la instalación y configuración del servidor <em>bind9</em> con las características anteriormente señaladas. Entrega las zonas que has definido. Muestra al profesor su funcionamiento.**</h4>
<p>Una vez hemos desinstalado el servidor <strong>dnsmasq</strong>, antes de instalar el servidor DNS <strong>bind9</strong>, vamos a realizar de nuevo una consulta a <code>www.josedomingo.org</code> para ver que servidor DNS nos responde ahora:</p>
<pre>
javier@debian:~$ dig www.josedomingo.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> www.josedomingo.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 54806
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.josedomingo.org.       IN  A

;; ANSWER SECTION:
www.josedomingo.org.    900 IN  CNAME   endor.josedomingo.org.
endor.josedomingo.org.  900 IN  A   37.187.119.60

;; Query time: 76 msec
;; SERVER: 212.166.132.110#53(212.166.132.110)
;; WHEN: mar dic 15 14:13:01 CET 2020
;; MSG SIZE  rcvd: 84
</pre>

<p>Vemos que ahora nos ha respondido un servidor DNS que ha obtenido por DHCP, cuya dirección es <em>212.166.132.110</em>, y que ya lógicamente no responde el que habíamos creado nosotros.</p>
<p>Realizada esta comprobación, sí vamos a instalar el servidor <strong>bind9</strong>:</p>
<pre>
apt install bind9 -y
</pre>

<p>Una vez instalado, debemos modificar su fichero de configuración, para ello nos dirigimos a <code>/etc/bind/named.conf.local</code> y añadimos el siguiente bloque:</p>
<pre>
include "/etc/bind/zones.rfc1918";

zone "iesgn.org" {
        type master;
        file "/var/cache/bind/db.iesgn.org";
};

zone "200.22.172.in-addr.arpa" {
        type master;
        file "/var/cache/bind/db.200.22.172";
};
</pre>

<p>Vamos a explicar las líneas que acabamos de añadir.</p>
<p>En primer lugar, hemos escrito una línea que hacer referencia a un archivo llamado <code>zones.rfc1918</code>, que es un fichero de configuración de las zonas privadas que queremos definir.</p>
<p>Los bloques definen las zonas de las que el servidor tiene autoridad, la <strong>zona de resolución directa</strong> <code>iesgn.org</code> con su correspondiente <strong>zona de resolución inversa</strong> <code>200.22.172.in-addr.arpa</code>, además vemos como hemos especificado que actúen como <strong>maestro</strong>.</p>
<p>Una vez explicado, tenemos que dirigirnos al fichero <code>/etc/bind/named.conf.options</code>, y aquí debemos introducir las siguientes líneas:</p>
<pre>
recursion yes;
allow-recursion { any; };
listen-on { any; };
allow-transfer { none; };
</pre>

<p>De manera, que el fichero <code>/etc/bind/named.conf.options</code> quedaría así:</p>
<pre>
options {
        directory "/var/cache/bind";

        dnssec-validation auto;

        listen-on-v6 { any; };

        recursion yes;

        allow-recursion { any; };

        listen-on { any; };

        allow-transfer { none; };

};
</pre>

<p>Ahora, vamos a configurar las zonas que definimos en el paso anterior. En mi caso copio el fichero <code>/etc/bind/db.empty</code> para utilizarlo como plantilla del nuevo archivo de configuración de esta <strong>zona de resolución directa</strong> <code>iesgn.org</code>.</p>
<pre>
root@javierpzh:~# cp /etc/bind/db.empty /var/cache/bind/db.iesgn.org
</pre>

<p>Hecho esto, empezamos a editar nuestro archivo <code>db.iesgn.org</code>:</p>
<pre>
$TTL    86400
@       IN      SOA     javierpzh.iesgn.org. root.localhost. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      javierpzh.iesgn.org.
@       IN      MX      10      correo.iesgn.org.

$ORIGIN iesgn.org.

javierpzh       IN      A       172.22.200.174
correo          IN      A       172.22.200.200
ftp             IN      A       172.22.200.201
www             IN      CNAME   javierpzh
departamentos   IN      CNAME   javierpzh
</pre>

<p>Voy a explicar el bloque añadido.</p>
<p>Los registros de tipo <strong>SOA</strong> representan las autoridad sobre las zonas.</p>
<p>El registro de tipo <strong>NS</strong> define el servidor con privilegios sobre la zona.</p>
<p>El registro de tipo <strong>MX</strong> indica que hacemos referencia a un servidor de correos.</p>
<p>El registro <strong>$ORIGIN</strong> se usa para que las líneas que se especifiquen debajo de él, sean autocompletadas con el dominio especificado en dicho registro. Esto nos sirve para evitar poner en cada registro que creemos, la zona, es decir, a los próximos registros que creemos, se les añadirá automáticamente la zona <code>iesgn.org</code>.</p>
<p>Los registros de tipo <strong>A</strong> especifican la direcciones IP correspondientes al dominio.</p>
<p>Los registros de tipo <strong>CNAME</strong> sirven para apuntar hacia otro de los registros de tipo <strong>A</strong> ya existentes. De manera que es mucho más fácil y cómodo hacer referencia a una dirección a través de un nombre en vez de con la propia dirección en sí.</p>
<p>Explicado estos detalles, reiniciamos el servidor DNS para que se apliquen los nuevos cambios:</p>
<pre>
systemctl restart bind9
</pre>

<p>Vamos a añadir al fichero <code>/etc/resolv.conf</code> de la máquina cliente la siguiente línea con la IP del servidor DNS (si ya la hemos añadido en la tarea 1, no hace falta obviamente):</p>
<pre>
nameserver 172.22.200.174
</pre>

<p>Hecho esto, ahora nuestro cliente utilizará nuestro servidor DNS <em>bind9</em>.</p>
<p>Antes hemos definido un registro <strong>SOA</strong> para definir la autoridad sobre la zona <code>iesgn.org</code>, que en teoría debería ser <code>javierpzh</code>. ¿Lo comprobamos? Vamos a asegurarnos. Para verificar la autoridad de una zona, hacemos uso del comando <code>dig ns (zona)</code>:</p>
<pre>
javier@debian:~$ dig ns iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> ns iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 32712
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 7b0f823027cdfdfb67ddfadd5fd8bdf3915ecc13d47da118 (good)
;; QUESTION SECTION:
;iesgn.org.         IN  NS

;; ANSWER SECTION:
iesgn.org.      86400   IN  NS  javierpzh.iesgn.org.

;; ADDITIONAL SECTION:
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; Query time: 81 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:45:22 CET 2020
;; MSG SIZE  rcvd: 106
</pre>

<p>Efectivamente, la autoridad sobre esta zona es <code>javierpzh</code>.</p>
<p>Hacemos una consulta al servidor DNS y preguntamos por la dirección <code>javierpzh.iesgn.org</code>:</p>
<pre>
javier@debian:~$ dig javierpzh.iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> javierpzh.iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 65344
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 3dcc5f35481cc4c49e80ce955fd8e176f2da3aa5d4f91551 (good)
;; QUESTION SECTION:
;javierpzh.iesgn.org.       IN  A

;; ANSWER SECTION:
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; AUTHORITY SECTION:
iesgn.org.      86400   IN  NS  javierpzh.iesgn.org.

;; Query time: 86 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:45:44 CET 2020
;; MSG SIZE  rcvd: 106
</pre>

<p>Ahora, haremos una consulta al servidor DNS y preguntaremos por el <strong>servidor de correos</strong> que hemos especificado, es decir, <code>correo.iesgn.org</code>:</p>
<pre>
javier@debian:~$ dig mx iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> mx iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 64754
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 0aca65684d6e77395f68519c5fd8be1045e75fe0b0b94080 (good)
;; QUESTION SECTION:
;iesgn.org.         IN  MX

;; ANSWER SECTION:
iesgn.org.      86400   IN  MX  10 correo.iesgn.org.

;; AUTHORITY SECTION:
iesgn.org.      86400   IN  NS  javierpzh.iesgn.org.

;; ADDITIONAL SECTION:
correo.iesgn.org.   86400   IN  A   172.22.200.200
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; Query time: 83 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:45:52 CET 2020
;; MSG SIZE  rcvd: 145
</pre>

<p>Vemos como nos responde con la información de este servidor de correos ficticio.</p>
<p>Ahora, haremos una consulta al servidor DNS y preguntaremos por el <strong>servidor FTP</strong> que hemos especificado, es decir, <code>ftp.iesgn.org</code>:</p>
<pre>
javier@debian:~$ dig ftp.iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> ftp.iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 5805
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: b890f6dcd25d80c0dc4ea1085fd8be2f91ea9ad925c3fdb5 (good)
;; QUESTION SECTION:
;ftp.iesgn.org.         IN  A

;; ANSWER SECTION:
ftp.iesgn.org.      86400   IN  A   172.22.200.201

;; AUTHORITY SECTION:
iesgn.org.      86400   IN  NS  javierpzh.iesgn.org.

;; ADDITIONAL SECTION:
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; Query time: 84 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:46:23 CET 2020
;; MSG SIZE  rcvd: 126
</pre>

<p>Vemos como nos responde con la información de este servidor FTP ficticio.</p>
<p>Vamos a probar si funcionan como deberían los registros <em>CNAME</em> haciendo una consulta a las direcciones <code>www.iesgn.org</code> y <code>departamentos.iesgn.org</code>:</p>
<pre>
javier@debian:~$ dig www.iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> www.iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 31627
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 294d876823b5bdd01a9627555fd8be65f78ac8bcb0b12c73 (good)
;; QUESTION SECTION:
;www.iesgn.org.         IN  A

;; ANSWER SECTION:
www.iesgn.org.      86400   IN  CNAME   javierpzh.iesgn.org.
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; AUTHORITY SECTION:
iesgn.org.      86400   IN  NS  javierpzh.iesgn.org.

;; Query time: 84 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:47:17 CET 2020
;; MSG SIZE  rcvd: 124

------------------------------------------------------------------------

javier@debian:~$ dig departamentos.iesgn.org

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> departamentos.iesgn.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 65267
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 6966c6cb36feec24d45b37dd5fd8be7de106924826689110 (good)
;; QUESTION SECTION:
;departamentos.iesgn.org.   IN  A

;; ANSWER SECTION:
departamentos.iesgn.org. 86400  IN  CNAME   javierpzh.iesgn.org.
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; AUTHORITY SECTION:
iesgn.org.      86400   IN  NS  javierpzh.iesgn.org.

;; Query time: 203 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:47:41 CET 2020
;; MSG SIZE  rcvd: 134
</pre>

<p>Lógicamente como he comentado antes, funciona.</p>
<p>Por último, para terminar esta tarea, vamos a configurar la zona inversa de nuestra servidor DNS <em>bind9</em>.</p>
<p>Al igual que hicimos al principio del ejercicio, vamos a tomar como plantilla un archivo, pero esta vez será el <code>/etc/bind/db.127</code> y lo guardaremos de nuevo en <code>/var/cache/bind</code> con el nombre <code>db.200.22.172</code>.</p>
<pre>
cp /etc/bind/db.127 /var/cache/bind/db.200.22.172
</pre>

<p>Antes de mostrar como quedaría este fichero, hay que decir que por cada registro de tipo <strong>A</strong> que tengamos en nuestro archivo que contiene la zona directa, sin incluir las páginas webs, tenemos que añadir un registro de tipo <strong>PTR</strong>.</p>
<p>En mi caso, el fichero <code>/var/cache/bind/db.db.200.22.172</code> tendría este aspecto:</p>
<pre>
$TTL    604800
@       IN      SOA     javierpzh.iesgn.org. root.localhost. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
@       IN      NS      javierpzh.iesgn.org.

$ORIGIN 200.22.172.in-addr.arpa.

174     IN      PTR     javierpzh.iesgn.org.
200     IN      PTR     correo.iesgn.org.
201     IN      PTR     ftp.iesgn.org.
</pre>

<p>Reiniciamos el servidor DNS para que se apliquen los nuevos cambios:</p>
<pre>
systemctl restart bind9
</pre>

<p>Para comprobar que funciona la resolución inversa, vamos a hacer una consulta inversa. Para hacer esto utilizamos el comando <code>dig -x (IP)</code>:</p>
<pre>
javier@debian:~$ dig -x 172.22.200.174

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> -x 172.22.200.174
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21938
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 7d3b873b603a177806bc97575fd8c12a2de7c483ab5f1672 (good)
;; QUESTION SECTION:
;174.200.22.172.in-addr.arpa.   IN  PTR

;; ANSWER SECTION:
174.200.22.172.in-addr.arpa. 604800 IN  PTR javierpzh.iesgn.org.

;; AUTHORITY SECTION:
200.22.172.in-addr.arpa. 604800 IN  NS  javierpzh.iesgn.org.

;; ADDITIONAL SECTION:
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; Query time: 79 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:59:06 CET 2020
;; MSG SIZE  rcvd: 147
</pre>

<p>Parece que el servidor resuelve consultas inversas, pero vamos a hacer una prueba más realizando otra consulta inversa, esta vez al servidor de correos.</p>
<pre>
javier@debian:~$ dig -x 172.22.200.200

; <<>> DiG 9.11.5-P4-5.1+deb10u2-Debian <<>> -x 172.22.200.200
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 61164
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 8551cca364e2557b2396263f5fd8c14e6b958e7180155dcf (good)
;; QUESTION SECTION:
;200.200.22.172.in-addr.arpa.   IN  PTR

;; ANSWER SECTION:
200.200.22.172.in-addr.arpa. 604800 IN  PTR correo.iesgn.org.

;; AUTHORITY SECTION:
200.22.172.in-addr.arpa. 604800 IN  NS  javierpzh.iesgn.org.

;; ADDITIONAL SECTION:
javierpzh.iesgn.org.    86400   IN  A   172.22.200.174

;; Query time: 81 msec
;; SERVER: 172.22.200.174#53(172.22.200.174)
;; WHEN: mar dic 15 14:59:42 CET 2020
;; MSG SIZE  rcvd: 154
</pre>

<p>Vemos que también funciona correctamente, por lo que este ejercicio estaría terminado.</p>
<h3>Servidor DNS esclavo</h3>
<h5>El servidor DNS actual funciona como <strong>DNS maestro</strong>. Vamos a instalar un nuevo servidor DNS que va a estar configurado como <strong>DNS esclavo</strong> del anterior, donde se van a ir copiando periódicamente las zonas del DNS maestro. Suponemos que el nombre del servidor DNS esclavo se va llamar <code>afrodita.iesgn.org</code>.</h5>
<h4>Tarea 3: Realiza la instalación del servidor DNS esclavo. Documenta los siguientes apartados:</h4>
<ul>
<li>
<p><strong>Entrega la configuración de las zonas del maestro y del esclavo.</strong></p>
</li>
<li>
<p><strong>Comprueba si las zonas definidas en el maestro tienen algún error con el comando adecuado.</strong></p>
</li>
<li>
<p><strong>Comprueba si la configuración de <code>named.conf</code> tiene algún error con el comando adecuado.</strong></p>
</li>
<li>
<p><strong>Reinicia los servidores y comprueba en los <em>logs</em> si hay algún error. No olvides incrementar el número de serie en el registro SOA si has modificado la zona en el maestro.</strong></p>
</li>
<li>
<p><strong>Muestra la salida del log donde se demuestra que se ha realizado la transferencia de zona.</strong></p>
</li>
</ul>
<h4>Tarea 4: Documenta los siguientes apartados:</h4>
<ul>
<li>
<p><strong>Configura un cliente para que utilice los dos servidores como servidores DNS.</strong></p>
</li>
<li>
<p><strong>Realiza una consulta con <code>dig</code> tanto al maestro como al esclavo para comprobar que las respuestas son autorizadas. ¿En qué te tienes que fijar?</strong></p>
</li>
<li>
<p><strong>Solicita una copia completa de la zona desde el cliente ¿qué tiene que ocurrir?. Solicita una copia completa desde el esclavo ¿qué tiene que ocurrir?</strong></p>
</li>
</ul>
<h4>Tarea 5: Muestra al profesor el funcionamiento del DNS esclavo:</h4>
<ul>
<li>
<p><strong>Realiza una consulta desde el cliente y comprueba que servidor está respondiendo.</strong></p>
</li>
<li>
<p><strong>Posteriormente apaga el servidor maestro y vuelve a realizar una consulta desde el cliente ¿quién responde?</strong></p>
</li>
</ul>
<h3>Delegación de dominios</h3>
<p><strong>Tenemos un servidor DNS que gestiona la zona correspondiente al nombre de dominio <code>iesgn.org</code>, en esta ocasión queremos delegar el subdominio <code>informatica.iesgn.org</code> para que lo gestione otro servidor DNS. Por lo tanto tenemos un escenario con dos servidores DNS:</strong></p>
<ul>
<li>
<p><strong><code>pandora.iesgn.org</code>, es servidor DNS autorizado para la zona <code>iesgn.org</code>.</strong></p>
</li>
<li>
<p><strong><code>ns.informatica.iesgn.org</code>, es el servidor DNS para la zona <code>informatica.iesgn.org</code> y, está instalado en otra máquina.</strong></p>
</li>
</ul>
<p><strong>Los nombres que vamos a tener en ese subdominio son los siguientes:</strong></p>
<ul>
<li>
<p><strong><code>www.informatica.iesgn.org</code> corresponde a un sitio web que está alojado en el servidor web del departamento de informática.</strong></p>
</li>
<li>
<p><strong>Vamos a suponer que tenemos un servidor FTP que se llame <code>ftp.informatica.iesgn.org</code> y que está en la misma máquina.</strong></p>
</li>
<li>
<p><strong>Vamos a suponer que tenemos un servidor para recibir los correos que se llame <code>correo.informatica.iesgn.org</code>.</strong></p>
</li>
</ul>
<h4>Tarea 6: Realiza la instalación y configuración del nuevo servidor DNS con las características anteriormente señaladas. Muestra el resultado al profesor.</h4>
<h4>Tarea 7: Realiza las consultas dig/neslookup desde los clientes preguntando por los siguientes:</h4>
<ul>
<li>
<p><strong>Dirección de <code>www.informatica.iesgn.org</code>, <code>ftp.informatica.iesgn.org</code>.</strong></p>
</li>
<li>
<p><strong>El servidor DNS que tiene configurado la zona del dominio <code>informatica.iesgn.org</code>. ¿Es el mismo que el servidor DNS con autoridad para la zona <code>iesgn.org</code>?</strong></p>
</li>
<li>
<p><strong>El servidor de correo configurado para <code>informatica.iesgn.org</code>.</strong></p>
</li>
</ul>
    </article>

        <div class="tags">
            <p><strong><a href="/tags">tags:</a></strong> <a href="/tag/dns.html">DNS</a>, <a href="/tag/bind9.html">bind9</a>, <a href="/tag/dnsmasq.html">dnsmasq</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://www.instagram.com/javierpzh/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/jperezhid_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/javierpzh">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.facebook.com/javier.perezhidalgo.904">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:javierperezhidalgo01@gmail.com">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-envelope-square fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog creado por <a href="http://www.instagram.com/javierpzh/">Javier Pérez Hidalgo</a>,
    con la utilización de <a href="https://blog.getpelican.com/">Pelican</a>. <br />        &copy;  Javier Pérez Hidalgo
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

</body>

</html>