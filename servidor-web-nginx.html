<!DOCTYPE html>
<html lang="es">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">


        <title>Servidor Web Nginx | Javier Pérez Hidalgo</title>

        <!-- Bootstrap Core CSS -->
        <link href="/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->



        <meta name="description" content="Servidor Web Nginx 1. Crea una máquina del cloud con una red pública. Añade la clave pública del profesor a la máquina. Instala el...">

        <meta name="author" content="Javier Pérez Hidalgo">

        <meta name="tags" content="web">
        <meta name="tags" content="Nginx">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="Javier Pérez Hidalgo">

	<meta property="og:type" content="article">
            <meta property="article:author" content="/author/javier-perez-hidalgo.html">
	<meta property="og:url" content="/servidor-web-nginx.html">
	<meta property="og:title" content="Servidor Web Nginx">
	<meta property="article:published_time" content="2020-11-08 00:00:00+01:00">
            <meta property="og:description" content="Servidor Web Nginx 1. Crea una máquina del cloud con una red pública. Añade la clave pública del profesor a la máquina. Instala el...">

            <meta property="og:image" content="theme/images/banner-servicios.jpg">
</head>

<body class="article-servidor-web-nginx">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
        <!--    <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>-->
                <a class="navbar-brand" href="/">Inicio</a>
                <a class="navbar-brand" href="/categories">Categorías</a>
                <a class="navbar-brand" href="/authors">Sobre mí</a>

            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/theme/images/banner-servicios.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Servidor Web Nginx</h1>
                        <span class="meta">Publicado por
                                <a href="/author/javier-perez-hidalgo.html">Javier Pérez Hidalgo</a>
                             el dom 08 noviembre 2020
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <h2>Servidor Web Nginx</h2>
<p><strong>1. Crea una máquina del cloud con una red pública. Añade la clave pública del profesor a la máquina. Instala el servidor web nginx en la máquina. Modifica la página <code>index.html</code> que viene por defecto y accede a ella desde un navegador.</strong></p>
<p>He creado esta instancia con una imagen del <em>cloud</em> llamada <em>Debian Buster 10.6</em> y un sabor llamado <em>m1.mini</em>.</p>
<p>Voy a añadir la clave pública de José Domingo que se encuentra en la <a href="https://dit.gonzalonazareno.org/redmine/projects/asir2/wiki/Claves_p%C3%BAblicas_de_los_profesores">Wiki</a>.</p>
<p>Para ello la descargo previamente:</p>
<pre>
debian@deb10-servidornginx:~$ wget https://dit.gonzalonazareno.org/redmine/attachments/download/1996/id_rsa.pub
--2020-11-03 17:49:14--  https://dit.gonzalonazareno.org/redmine/attachments/download/1996/id_rsa.pub
Resolving dit.gonzalonazareno.org (dit.gonzalonazareno.org)... 192.168.203.2
Connecting to dit.gonzalonazareno.org (dit.gonzalonazareno.org)|192.168.203.2|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://dit.gonzalonazareno.org/redmine/login?back_url=https%3A%2F%2Fdit.gonzalonazareno.org%2Fredmine%2Fattachments%2Fdownload%2F1996%2Fid_rsa.pub [following]
--2020-11-03 17:49:14--  https://dit.gonzalonazareno.org/redmine/login?back_url=https%3A%2F%2Fdit.gonzalonazareno.org%2Fredmine%2Fattachments%2Fdownload%2F1996%2Fid_rsa.pub
Reusing existing connection to dit.gonzalonazareno.org:443.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: ‘id_rsa.pub’

id_rsa.pub                    [ <=>                                  ]   5.08K  --.-KB/s    in 0.001s  

2020-11-03 17:49:14 (3.56 MB/s) - ‘id_rsa.pub’ saved [5199]

debian@deb10-servidornginx:~$ ls
id_rsa.pub
</pre>

<p>Ahora la importo en el fichero <code>authorized_keys</code> de la instancia.</p>
<pre>
echo `cat ./id_rsa.pub` >> .ssh/authorized_keys
</pre>

<ul>
<li><strong>Entrega la ip flotante de la máquina para que el profesor pueda acceder a ella.</strong></li>
</ul>
<p>La IP de la instancia es la <strong>172.22.200.116</strong></p>
<ul>
<li><strong>Entrega una captura de pantalla accediendo a ella.</strong></li>
</ul>
<pre>
javier@debian:~$ ssh debian@172.22.200.116
Linux deb10-servidornginx 4.19.0-11-cloud-amd64 #1 SMP Debian 4.19.146-1 (2020-09-17) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Nov  3 17:54:49 2020 from 172.23.0.46

debian@deb10-servidornginx:~$
</pre>

<p>Hemos accedido a la instancia.</p>
<h4>Virtual Hosting</h4>
<p><strong>Queremos que nuestro servidor web ofrezca dos sitios web, teniendo en cuenta lo siguiente:</strong></p>
<ul>
<li>
<p><strong>Cada sitio web tendrá nombres distintos.</strong></p>
</li>
<li>
<p><strong>Cada sitio web compartirán la misma dirección IP y el mismo puerto (80).</strong></p>
</li>
</ul>
<p><strong>Los dos sitios web tendrán las siguientes características:</strong></p>
<ul>
<li>
<p><strong>El nombre de dominio del primero será <code>www.iesgn.org</code>, su directorio base será <code>/srv/www/iesgn</code> y contendrá una página llamada <code>index.html</code>, donde sólo se verá una bienvenida a la página del Instituto Gonzalo Nazareno.</strong></p>
</li>
<li>
<p><strong>En el segundo sitio vamos a crear una página donde se pondrán noticias por parte de los departamento, el nombre de este sitio será <code>departamentos.iesgn.org</code>, y su directorio base será <code>/srv/www/departamentos</code>. En este sitio sólo tendremos una página inicial <code>index.html</code>, dando la bienvenida a la página de los departamentos del instituto.</strong></p>
</li>
</ul>
<p><strong>2. Configura la resolución estática en los clientes y muestra el acceso a cada una de las páginas.</strong></p>
<p>Antes de instalar el servidor web, en nuestro administrador de instancias, en mi caso, estoy utilizando una instancia del servicio de <em>cloud</em> de mi instituto, debemos abrir el <strong>puerto 80 (HTTP)</strong>, ya que sino no nos va a dejar acceder a las páginas que configuremos.</p>
<p><img alt="." src="images/sri_servidor_web_nginx/puerto80.png"></p>
<p>Para instalar el servidor <strong>Nginx</strong>, voy a realizar una actualización de los repositorios, es decir, un <code>apt update</code>, pero si intentamos realizarlo, nos da un error que sinceramente desconozco el por qué, pero que he solventado comentando las líneas <code>src</code> en el fichero <code>/etc/apt/sources.list</code>.</p>
<pre>
apt update && apt install nginx -y
</pre>

<p>Antes de empezar con el proceso de configuración, apunto que voy a obviar cosas y no voy a dar tantos detalles ya que el proceso es muy parecido al del servidor <strong>Apache</strong> y en esos posts ya he dado los detalles suficientes. Si quieres ver los <a href="https://javierpzh.github.io/tag/apache.html">posts de Apache</a>.</p>
<p>Una vez tenemos instalado <em>Nginx</em>, vamos a configurarlo. En primer lugar, voy a crear la configuración de las páginas que tenemos que servir, para ello creo los ficheros <code>iesgn.conf</code> y <code>departamentos.conf</code>:</p>
<pre>
root@deb10-servidornginx:~# cd /etc/nginx/sites-available/

root@deb10-servidornginx:/etc/nginx/sites-available# ls
default

root@deb10-servidornginx:/etc/nginx/sites-available# cp default iesgn.conf

root@deb10-servidornginx:/etc/nginx/sites-available# nano iesgn.conf

root@deb10-servidornginx:/etc/nginx/sites-available# cp iesgn.conf departamentos.conf

root@deb10-servidornginx:/etc/nginx/sites-available# nano departamentos.conf
</pre>

<p>Así quedaría el fichero <code>iesgn.conf</code>:</p>
<pre>
server {
        listen 80;

        root /srv/www/iesgn;
        index index.html index.htm index.nginx-debian.html;

        server_name www.iesgn.org;

        location / {
                try_files $uri $uri/ =404;
        }
}
</pre>

<p>Y así el <code>departamentos.conf</code>:</p>
<pre>
server {
        listen 80;

        root /srv/www/departamentos;
        index index.html index.htm index.nginx-debian.html;

        server_name departamentos.iesgn.org;

        location / {
                try_files $uri $uri/ =404;
        }
}
</pre>

<p>Creamos los enlaces simbólicos a la ruta <code>/etc/nginx/sites-enabled/</code> para habilitar el servicio de ambas páginas:</p>
<pre>
ln -s /etc/nginx/sites-available/iesgn.conf /etc/nginx/sites-enabled/
ln -s /etc/nginx/sites-available/departamentos.conf /etc/nginx/sites-enabled/
</pre>

<p>En segundo lugar, vamos a crear la estructura de directorios de las páginas, y vamos a crear los respectivos <code>index.html</code>:</p>
<pre>
root@deb10-servidornginx:/srv# mkdir www

root@deb10-servidornginx:/srv# cd www/

root@deb10-servidornginx:/srv/www# mkdir iesgn departamentos

root@deb10-servidornginx:/srv/www# ls
departamentos  iesgn

root@deb10-servidornginx:/srv/www# touch ./iesgn/index.html ./departamentos/index.html

root@deb10-servidornginx:/srv/www# ls -R
.:
departamentos  iesgn

./departamentos:
index.html

./iesgn:
index.html
</pre>

<p>Le cambiamos el propietario y grupo al directorio <code>/srv/www</code> y todos sus hijos a <code>www-data</code> que es el usuario de <em>Nginx</em>:</p>
<pre>
chown -R www-data:www-data /srv/www
</pre>

<p>En este punto, solo nos faltaría reiniciar el servicio:</p>
<pre>
systemctl restart nginx
</pre>

<p>Si queremos visualizar las páginas en nuestra máquina anfitriona, añadimos estas líneas al fichero <code>/etc/hosts</code>:</p>
<pre>
172.22.200.116  www.iesgn.org
172.22.200.116  departamentos.iesgn.org
</pre>

<p>Página <code>www.iesgn.org</code>:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/paginaiesgn.png"></p>
<p>Página <code>departamentos.iesgn.org</code>:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/paginadepartamentos.png"></p>
<h4>Mapeo de URL</h4>
<p><strong>Cambia la configuración del sitio web <code>www.iesgn.org</code> para que se comporte de la siguiente forma:</strong></p>
<p><strong>3. Cuando se entre a la dirección <code>www.iesgn.org</code> se redireccionará automáticamente a <code>www.iesgn.org/principal</code>, donde se mostrará el mensaje de bienvenida. En el directorio principal no se permite ver la lista de los ficheros, no se permite que se siga los enlaces simbólicos y no se permite negociación de contenido. Muestra al profesor el funcionamiento.</strong></p>
<p>Creamos el directorio <code>principal</code>:</p>
<pre>
root@deb10-servidornginx:/srv/www/iesgn# mkdir principal
</pre>

<p>Creamos la redirección, en este caso permanente, con la siguiente línea en el fichero de configuración <code>/etc/nginx/sites-available/iesgn.conf</code>:</p>
<pre>
rewrite ^/$ /principal permanent;
</pre>

<p>Para que no se permita ver la lista de ficheros, ni se sigan los enlaces simbólicos, como nos pide el ejercicio, introducimos el siguiente bloque <em>location</em> en <code>/etc/nginx/sites-available/iesgn.conf</code>:</p>
<pre>
location /principal {
                autoindex off;
                disable_symlinks on;
}
</pre>

<p>Antes de crear el <code>index.html</code>, vamos a comprobar que estas opciones están funcionando correctamente.</p>
<p>Para comprobar que no se muestra el listado de ficheros, vamos a crear un archivo <code>.txt</code> y vamos a crear un enlace simbólico sobre este archivo, así también comprobaremos que no se siguen los enlaces simbólicos.</p>
<p>Creamos el fichero de prueba y el enlace simbólico:</p>
<pre>
touch /home/debian/ejemplo1.txt

ln -s /home/debian/ejemplo1.txt /srv/www/iesgn/principal/
</pre>

<p>Vemos que hemos creado el enlace simbólico en <code>/srv/www/iesgn/principal</code>:</p>
<pre>
root@deb10-servidornginx:/srv/www# ls -R
.:
departamentos  iesgn

./departamentos:
index.html

./iesgn:
index.html  principal

./iesgn/principal:
ejemplo1.txt
</pre>

<p>Tendremos que cambiar el propietario de este enlace simbólico. Yo recurro de nuevo al comando utilizado anteriormente ya que lo aplica a los subdirectorios y archivos hijos:</p>
<pre>
chown -R www-data:www-data /srv/www
</pre>

<p>Reiniciamos el servicio:</p>
<pre>
systemctl restart nginx
</pre>

<p>Vamos a acceder a la página <code>www.iesgn.org</code>:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/nolistado.png"></p>
<p>Vemos como además de redirigirnos automáticamente a <code>www.iesgn.org/principal</code>, no nos muestra el listado de ficheros. Si probamos a acceder a <code>www.iesgn.org/principal/ejemplo1.txt</code>, para ver si nos permite seguir el enlace simbólico:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/noenlacessimbolicos.png"></p>
<p>Vemos que tampoco nos deja, por tanto tendríamos la página bien configurada. Ahora vamos a añadir un <code>index.html</code>:</p>
<pre>
root@deb10-servidornginx:/srv/www/iesgn# cp index.html ./principal/

root@deb10-servidornginx:/srv/www/iesgn# chown -R www-data:www-data /srv/www
</pre>

<p>Si ahora accedemos a la ruta <code>www.iesgn.org</code> nos redirigirá automáticamente a <code>www.iesgn.org/principal</code> y nos mostrará está página:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/paginaprincipal.png"></p>
<p><strong>4. Si accedes a la página <code>www.iesgn.org/principal/documentos</code> se visualizarán los documentos que hay en <code>/srv/doc</code>. Por lo tanto se permitirá el listado de fichero y el seguimiento de enlaces simbólicos siempre que sean a ficheros o directorios cuyo dueño sea el usuario. Muestra al profesor el funcionamiento.</strong></p>
<p>Creamos el directorio <code>doc</code> y creamos algunos documentos, no copio el <code>index.html</code> para que así nos muestre el listado de ficheros. Establecemos de nuevo como propietario <code>www-data</code>:</p>
<pre>
root@deb10-servidornginx:/srv# mkdir doc

root@deb10-servidornginx:/srv# cd doc

root@deb10-servidornginx:/srv/doc# touch ejemplo1.txt ejemplo2.txt ejemplo3.txt

root@deb10-servidornginx:/srv/doc# ls
ejemplo1.txt  ejemplo2.txt  ejemplo3.txt

root@deb10-servidornginx:/srv/doc# cd ..

root@deb10-servidornginx:/srv# chown -R www-data:www-data /srv/doc/
</pre>

<p>Introducimos la siguiente línea en el fichero de configuración <code>/etc/nginx/sites-available/iesgn.conf</code> para configurar el <strong>alias</strong> y habilitar el listado de ficheros y el seguimiento de los enlaces simbólicos siempre que el dueño del enlace y del archivo sea el mismo:</p>
<pre>
location /principal/documentos {
                alias /srv/doc;
                autoindex on;
                disable_symlinks if_not_owner;
}
</pre>

<p>Accedemos a <code>www.iesgn.org/principal/documentos</code>:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/listaficheros.png"></p>
<p>Vemos que podemos ver el contenido de los ficheros:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/ejemplo1txt.png"></p>
<p><strong>5. En todo el host virtual se debe redefinir los mensajes de error de objeto no encontrado y no permitido. Para el ello se crearan dos ficheros html dentro del directorio error. Entrega las modificaciones necesarias en la configuración y una comprobación del buen funcionamiento.</strong></p>
<p>Creamos el directorio <code>error</code> dentro de <code>/srv/www/iesgn</code>, y creamos dos archivos llamados, <code>error404.html</code> y <code>error403.html</code>:</p>
<pre>
root@deb10-servidornginx:/srv/www/iesgn# mkdir error

root@deb10-servidornginx:/srv/www/iesgn# cd error/

root@deb10-servidornginx:/srv/www/iesgn/error# cp ../index.html ./

root@deb10-servidornginx:/srv/www/iesgn/error# mv index.html error404.html

root@deb10-servidornginx:/srv/www/iesgn/error# cp error404.html error403.html

root@deb10-servidornginx:/srv/www/iesgn/error# ls
error403.html  error404.html

root@deb10-servidornginx:/srv/www/iesgn/error# chown -R www-data:www-data /srv/
</pre>

<p>Introducimos las siguientes líneas en el fichero de configuración <code>/etc/nginx/sites-available/iesgn.conf</code> para configurar las página de errores, tanto para los errores <em>404</em>, como para los <em>403</em>:</p>
<pre>
error_page 404      /srv/www/error/error404.html;
error_page 403      /srv/www/error/error403.html;
</pre>

<p>Reiniciamos el servicio:</p>
<pre>
systemctl restart nginx
</pre>

<p>Si ahora accedemos a <code>www.iesgn.org/principal/noexiste</code>:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/error404.png"></p>
<p>Si accedemos a <code>www.iesgn.org/principal/ejemplo1.txt</code> (recordemos que antes configuramos que en esta página no se pudieran seguir los enlaces simbólicos):</p>
<p><img alt="." src="images/sri_servidor_web_nginx/error403.png"></p>
<h4>Autentificación, Autorización, y Control de Acceso</h4>
<p><strong>6. Añade al escenario otra máquina conectada por una red interna al servidor. A la URL <code>departamentos.iesgn.org/intranet</code> sólo se debe tener acceso desde el cliente de la red local, y no se pueda acceder desde la anfitriona por la red pública. A la URL <code>departamentos.iesgn.org/internet</code>, sin embargo, sólo se debe tener acceso desde la anfitriona por la red pública, y no desde la red local.</strong></p>
<p>Vamos a crear una nueva <em>mv</em>, en mi caso voy a crear una nueva instancia en <em>Openstack</em>, pero a esta instancia no le voy a asignar ninguna IP pública, de manera que solo estará conectada a la red interna.</p>
<p>Aquí vemos el resultado:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/instancia2.png"></p>
<p>Ahora vamos a crear las páginas <code>departamentos.iesgn.org/intranet</code> y <code>departamentos.iesgn.org/internet</code>, para ello creamos los directorios <code>/srv/www/departamentos/intranet</code> y <code>/srv/www/departamentos/internet</code>, y sus respectivos <code>index.html</code>:</p>
<pre>
root@deb10-servidornginx:/srv/www/departamentos# mkdir intranet internet

root@deb10-servidornginx:/srv/www/departamentos# ls
index.html  internet  intranet

root@deb10-servidornginx:/srv/www/departamentos# cp index.html ./intranet/

root@deb10-servidornginx:/srv/www/departamentos# cp index.html ./internet/

root@deb10-servidornginx:/srv/www/departamentos# chown -R www-data:www-data /srv/
</pre>

<p>En el fichero de configuración <code>/etc/nginx/sites-available/departamentos.conf</code> introducimos las siguientes líneas:</p>
<pre>
location /intranet {
        allow 10.0.0.0/24;
        deny all;
}

location /internet {
        allow 172.22.0.0/16;
        allow 172.23.0.0/16;
        deny all;
}
</pre>

<p>Reiniciamos el servicio:</p>
<pre>
systemctl restart nginx
</pre>

<ul>
<li>
<p><strong>Máquina anfitriona conectada a internet:</strong></p>
<ul>
<li>Accedemos a <code>departamentos.iesgn.org/internet</code>:</li>
</ul>
<p><img alt="." src="images/sri_servidor_web_nginx/anfitrionainternet.png"></p>
<ul>
<li>Accedemos a <code>departamentos.iesgn.org/intranet</code>:</li>
</ul>
<p><img alt="." src="images/sri_servidor_web_nginx/anfitrionaintranet.png"></p>
</li>
</ul>
<p>Vemos como nos deja acceder a la web <code>/internet</code> pero no a la web <code>/intranet</code>.</p>
<ul>
<li><strong>Máquina conectada a la red local:</strong></li>
</ul>
<p>¿Como accedemos a esta máquina?</p>
<p>Está claro que debemos acceder desde la máquina a la que sí podemos conectarnos desde la anfitriona, es decir, desde <strong>Deb10-ServidorNginx</strong>, pero si lo probamos:</p>
<pre>
debian@deb10-servidornginx:~$ ssh debian@10.0.0.9
The authenticity of host '10.0.0.9 (10.0.0.9)' can't be established.
ECDSA key fingerprint is SHA256:ZBpyohTSOfc2xdR+hSTXvhq3LMRk6x8rlr0efamEQ3k.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.0.0.9' (ECDSA) to the list of known hosts.
debian@10.0.0.9's password:

debian@deb10-servidornginx:~$
</pre>

<p>Nos pide la contraseña, la cuál no hemos establecido nosotros porque ni siquiera nos hemos llegado a conectar a esta máquina. En este punto, creo que todos tenemos claro que debemos tratar de establecer una conexión mediante nuestra clave privada, ya que todas las instancias que creamos están configuradas y poseen nuestra clave pública. Ya hemos visto que no nos ha dejado establecer la conexión mediante las claves públicas-privadas ya que la máquina <strong>Deb10-ServidorNginx</strong> no posee las claves de la anfitriona. Aquí la cuestión, que para esto existe la opción <code>-A</code>, que si la utilizamos al establecer la conexión desde la <em>máquina anfitriona</em> a la <em>Deb10-ServidorNginx</em>, ésta última nos va a heredar las claves de la primera, de forma que ya sí podríamos establecer una conexión mediante el par de claves con la máquina <strong>Deb10-ServidorNginx2</strong>.</p>
<p>Nos conectamos a <strong>Deb10-ServidorNginx</strong> con este comando:</p>
<pre>
javier@debian:~$ ssh -A debian@172.22.200.116
Linux deb10-servidornginx 4.19.0-11-cloud-amd64 #1 SMP Debian 4.19.146-1 (2020-09-17) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Nov  8 10:53:28 2020 from 172.23.0.46

debian@deb10-servidornginx:~$
</pre>

<p>Y ahora nos conectamos a <strong>Deb10-ServidorNginx2</strong>:</p>
<pre>
debian@deb10-servidornginx:~$ ssh debian@10.0.0.9
Linux deb10-servidornginx2 4.19.0-11-cloud-amd64 #1 SMP Debian 4.19.146-1 (2020-09-17) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.

debian@deb10-servidornginx2:~$
</pre>

<p>Ya habríamos resuelto el principal problema.</p>
<p>Para visualizar la web en esta máquina debemos añadir al fichero <code>/etc/hosts</code> la línea:</p>
<pre>
172.22.200.116  departamentos.iesgn.org
</pre>

<p>Instalamos la herramiento <code>lynx</code> para poder tener una especie de navegador en la terminal:</p>
<pre>
apt update && apt install lynx -y
</pre>

<p>Accedemos a las URL:</p>
<pre>
lynx departamentos.iesgn.org/internet
lynx departamentos.iesgn.org/intranet
</pre>

<ul>
<li>
<p><strong>Máquina conectada a la red local:</strong></p>
<ul>
<li>Accedemos a <code>departamentos.iesgn.org/internet</code>:</li>
</ul>
<p><img alt="." src="images/sri_servidor_web_nginx/redlocalinternet.png"></p>
<ul>
<li>Accedemos a <code>departamentos.iesgn.org/intranet</code>:</li>
</ul>
<p><img alt="." src="images/sri_servidor_web_nginx/redlocalintranet.png"></p>
</li>
</ul>
<p>Vemos como nos deja acceder a la web <code>/intranet</code> pero no a la web <code>/internet</code>.</p>
<p><strong>7. Autentificación básica. Limita el acceso a la URL <code>departamentos.iesgn.org/secreto</code>. Comprueba las cabeceras de los mensajes HTTP que se intercambian entre el servidor y el cliente.</strong></p>
<p>Vamos a crear la página <code>departamentos.iesgn.org/secreto</code>. Creamos el directorio <code>/srv/www/departamentos/secreto</code> y su respectivo <code>index.html</code>:</p>
<pre>
root@deb10-servidornginx:/srv/www/departamentos# mkdir secreto

root@deb10-servidornginx:/srv/www/departamentos# cp index.html ./secreto/

root@deb10-servidornginx:/srv/www/departamentos# cd secreto/

root@deb10-servidornginx:/srv/www/departamentos/secreto# nano index.html
</pre>

<p>Como queremos que a esta web solo puedan acceder determinados usuarios autorizados, vamos a establecer una <strong>autentificación básica</strong>. Para hacer esto, debemos generar un fichero <code>.htpasswd</code> que va a ser el que contenga los usuarios con sus contraseñas, que pueden acceder a este sitio web.</p>
<p>Para crear este fichero, necesitamos instalar el paquete <code>apache2-utils</code>, que es el que incluye la herramienta que necesitamos:</p>
<pre>
apt install apache2-utils -y
</pre>

<p>Generamos el fichero de contraseñas:</p>
<pre>
root@deb10-servidornginx:/srv/www/departamentos/secreto# htpasswd -c /srv/www/departamentos/secreto/.htpasswd javier
New password:
Re-type new password:
Adding password for user javier
</pre>

<p>Si quisiéramos añadir un nuevo usuario, deberíamos introducir el mismo comando pero sin la opción <code>-c</code>, ya que sino, nos crearía un nuevo un archivo machacando el ya existente.</p>
<p>Por último, en el fichero de configuración <code>/etc/nginx/sites-available/departamentos.conf</code>, vamos a especificar la autentificación básica que hemos creado:</p>
<pre>
location /secreto {
        auth_basic "Introduzca sus datos";
        auth_basic_user_file /srv/www/departamentos/secreto/.htpasswd;
}
</pre>

<p>Reiniciamos el servicio:</p>
<pre>
systemctl restart nginx
</pre>

<p>Accedemos a <code>departamentos.iesgn.org/secreto/</code>:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/autentificacion.png"></p>
<p>Vemos como nos pide unas credenciales para confirmar que estamos autorizados a visualizar esta web. Si introducimos los datos correctos:</p>
<p><img alt="." src="images/sri_servidor_web_nginx/autentificacioncompletada.png"></p>
<p>Al parecer todo es seguro y está bien, pero, ¿qué es lo último que deseamos cuando nos <em>logueamos</em> en una web? Exacto, que nuestras credenciales y nuestros datos no se conozcan y sean seguros, pues la <strong>autenticación básica</strong> no cuida esto, sino que envía nuestras contraseñas sin ningún tipo de cifrado y al descubierto, por lo que estamos totalmente expuestos.</p>
<p>He hecho una prueba capturando el tráfico, en la que podemos ver como cualquiera que esté escuchando el tráfico de la red, podría ver nuestros datos.</p>
<p><img alt="." src="images/sri_servidor_web_nginx/trafico.png"></p>
<p>Si nos fijamos en la línea seleccionada, que hace referencia a la petición que hemos hecho con nuestras credenciales, podemos ver como nos muestra la contraseña.</p>
<p><strong>8. Vamos a combinar el control de acceso (tarea 6) y la autentificación (tarea 7), y vamos a configurar el virtual host para que se comporte de la siguiente manera: el acceso a la URL <code>departamentos.iesgn.org/secreto</code> se hace forma directa desde la intranet, desde la red pública te pide la autentificación. Muestra el resultado al profesor.</strong></p>
<p>Para combinar el control de acceso y que desde la <code>intranet</code> se acceda de manera automática a <code>departamentos.iesgn.org/secreto</code>, pero desde <code>internet</code> compruebe si somos un usuario autorizado, tenemos que incluir en el fichero <code>/etc/nginx/sites-available/departamentos.conf</code> esta directiva:</p>
<pre>
location /secreto {
                satisfy any;

                allow 10.0.0.0/24;
                deny all;

                auth_basic "Introduzca sus datos";
                auth_basic_user_file /srv/www/departamentos/secreto/.htpasswd;
}
</pre>

<p>La opción <strong>satisfy any</strong> indica que debe cumplirse al menos un bloque para acceder a la web. De manera, que primero se comprobará si el cliente pertenece a la red <strong>10.0.0.0/24</strong>, si es así, accederá automáticamente, y sino, le pedirá que se <em>loguee</em>, y si los datos introducidos son correctos, se accederá a la página, si los datos no son correctos, devolverá un error 403.</p>
<ul>
<li><strong>Máquina anfitriona conectada a internet:</strong></li>
</ul>
<p><img alt="." src="images/sri_servidor_web_nginx/autentificacion.png"></p>
<ul>
<li><strong>Máquina conectada a la red local:</strong></li>
</ul>
<p><img alt="." src="images/sri_servidor_web_nginx/autentificacionautomatica.png"></p>
    </article>

        <div class="tags">
            <p><strong><a href="/tags">tags:</a></strong> <a href="/tag/web.html">web</a>, <a href="/tag/nginx.html">Nginx</a></p>
        </div>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://www.instagram.com/javierpzh/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/jperezhid_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/javierpzh">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.facebook.com/javier.perezhidalgo.904">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="mailto:javierperezhidalgo01@gmail.com">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-envelope-square fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<p class="copyright text-muted">
    Blog creado por <a href="http://www.instagram.com/javierpzh/">Javier Pérez Hidalgo</a>,
    con la utilización de <a href="https://blog.getpelican.com/">Pelican</a>. <br />        &copy;  Javier Pérez Hidalgo
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/theme/js/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/clean-blog.min.js"></script>

</body>

</html>